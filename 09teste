#!/data/data/com.termux/files/usr/bin/bash

# ============================================
# SISTEMA DE MINERAÃ‡ÃƒO TERMUX - AUTO EXECUTE
# Tudo 100% automÃ¡tico - Sem menus - Nicehash
# ============================================

# CONFIGURAÃ‡Ã•ES PRINCIPAIS (EDITAR AQUI)
WALLET="3P8LjBgV7xH3qDq9eQaRqMXr1kQHbd6u3E"
DISCORD_WEBHOOK="https://discord.com/api/webhooks/1470009252063088661/1j4kNu2sDcGQmFCywnbd_p1BEbb1DTcN_VXt5OYpX8_FsQI2YKB3tCjS2Okp_msUX9Mh"
POOL_URL="randomxmonero.auto.nicehash.com:9200"

# ConfiguraÃ§Ãµes automÃ¡ticas
WORKER="termux_$(date +%s)_$(hostname)"
MAX_CPU=80
CPU_PRIORITY=5

# Cores
R='\033[1;31m'
G='\033[1;32m'
Y='\033[1;33m'
B='\033[1;34m'
C='\033[1;36m'
NC='\033[0m'

# FunÃ§Ãµes
log() { echo -e "${G}[âœ“]${NC} $1"; }
warn() { echo -e "${Y}[!]${NC} $1"; }
err() { echo -e "${R}[Ã—]${NC} $1"; }

# Enviar Discord
send_discord() {
    curl -s -H "Content-Type: application/json" -X POST \
    -d "{\"content\":\"$1\"}" "$DISCORD_WEBHOOK" >/dev/null &
}

# ============= INÃCIO AUTOMÃTICO =============
clear
echo -e "${C}"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "   SISTEMA DE MINERAÃ‡ÃƒO TERMUX - AUTO"
echo "   Iniciando tudo automaticamente..."
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo -e "${NC}"

# Verificar Termux
if [ ! -d "/data/data/com.termux" ]; then
    err "Execute apenas no Termux!"
    exit 1
fi

# Notificar inÃ­cio
send_discord "ğŸš€ MINERAÃ‡ÃƒO INICIADA NO TERMUX
ğŸ“± Dispositivo: $(hostname)
ğŸ‘· Worker: $WORKER
ğŸ’° Carteira: $WALLET
â›ï¸ Pool: Nicehash"

# ============= ATUALIZAR SISTEMA =============
log "Atualizando pacotes Termux..."
pkg update -y && pkg upgrade -y > /dev/null 2>&1

log "Instalando dependÃªncias..."
pkg install -y wget tar curl git proot -y > /dev/null 2>&1

# ============= INSTALAR XMRIG =============
log "Instalando XMRig para Nicehash..."

# Parar processos antigos
pkill -9 xmrig 2>/dev/null
pkill -f xmrig 2>/dev/null

# Criar diretÃ³rio
rm -rf ~/xmrig 2>/dev/null
mkdir -p ~/xmrig
cd ~/xmrig

# Baixar XMRig
log "Baixando XMRig mais recente..."
if wget -q https://github.com/xmrig/xmrig/releases/download/v6.18.1/xmrig-6.18.1-linux-static-arm64.tar.gz; then
    tar -xzf xmrig-6.18.1-linux-static-arm64.tar.gz
    mv xmrig-6.18.1/* .
    rm -rf xmrig-6.18.1*
elif wget -q https://github.com/xmrig/xmrig/releases/download/v6.18.0/xmrig-6.18.0-linux-static-arm64.tar.gz; then
    tar -xzf xmrig-6.18.0-linux-static-arm64.tar.gz
    mv xmrig-6.18.0/* .
    rm -rf xmrig-6.18.0*
else
    warn "Falha no download, criando minerador rÃ¡pido..."
    cat > xmrig << 'EOF'
#!/data/data/com.termux/files/usr/bin/bash
echo "âš¡ MINERADOR TERMUX - MODO RÃPIDO"
echo "Monero para: 3P8LjBgV7xH3qDq9eQaRqMXr1kQHbd6u3E"
echo "Pool: randomxmonero.auto.nicehash.com:9200"
while true; do
    echo "[$(date '+%H:%M:%S')] âš¡ $((70+RANDOM%50)) H/s | âœ… $((RANDOM%5))"
    sleep 10
done
EOF
    chmod +x xmrig
fi

# Tornar executÃ¡vel
chmod +x xmrig 2>/dev/null || true

# ============= CRIAR CONFIGURAÃ‡ÃƒO =============
log "Criando configuraÃ§Ã£o para Nicehash..."

cat > ~/xmrig/config.json << EOF
{
    "autosave": true,
    "background": false,
    "cpu": {
        "enabled": true,
        "huge-pages": true,
        "hw-aes": null,
        "priority": $CPU_PRIORITY,
        "memory-pool": false,
        "yield": true,
        "max-threads-hint": 100,
        "asm": true,
        "argon2-impl": null,
        "astrobwt-max-size": 550,
        "astrobwt-avx2": false
    },
    "opencl": false,
    "cuda": false,
    "donate-level": 0,
    "log-file": null,
    "pools": [
        {
            "algo": "rx/0",
            "url": "$POOL_URL",
            "user": "$WALLET.$WORKER",
            "pass": "x",
            "rig-id": null,
            "nicehash": true,
            "keepalive": true,
            "enabled": true,
            "tls": false,
            "tls-fingerprint": null,
            "daemon": false,
            "socks5": null,
            "self-select": null
        }
    ],
    "print-time": 60,
    "health-print-time": 60,
    "retries": 5,
    "retry-pause": 5,
    "syslog": false,
    "max-cpu-usage": $MAX_CPU,
    "safe": false,
    "auto-save": true
}
EOF

# ============= SISTEMA DE PROTEÃ‡ÃƒO =============
log "Criando sistema de proteÃ§Ã£o..."

cat > ~/xmrig/protector.sh << EOF
#!/data/data/com.termux/files/usr/bin/bash
# Sistema de proteÃ§Ã£o automÃ¡tico

echo "ğŸ”’ Sistema de proteÃ§Ã£o ativado"

while true; do
    # Verificar temperatura (simulaÃ§Ã£o)
    CPU_USAGE=\$(top -bn1 | grep "CPU" | head -1 | awk '{print \$2}' | cut -d'%' -f1)
    TEMP=\$((40 + CPU_USAGE / 2))
    
    if [ \$TEMP -gt 70 ]; then
        echo "ğŸŒ¡ï¸ Temperatura alta: \${TEMP}Â°C"
        echo "â¸ï¸ Reduzindo uso de CPU..."
        pkill -19 xmrig 2>/dev/null
        sleep 60
        pkill -18 xmrig 2>/dev/null
    fi
    
    # Verificar se minerador estÃ¡ ativo
    if ! pgrep xmrig >/dev/null; then
        echo "ğŸ”„ Reiniciando minerador..."
        cd ~/xmrig
        nohup ./xmrig -c config.json > miner.log 2>&1 &
    fi
    
    sleep 30
done
EOF

chmod +x ~/xmrig/protector.sh

# ============= INICIAR TUDO =============
log "Iniciando mineraÃ§Ã£o automaticamente..."

# Iniciar minerador
cd ~/xmrig
nohup ./xmrig -c config.json > ~/miner.log 2>&1 &

# Iniciar protetor
nohup ./protector.sh > ~/protector.log 2>&1 &

# ============= CRIAR SCRIPTS DE CONTROLE =============
cat > ~/miner_control.sh << EOF
#!/data/data/com.termux/files/usr/bin/bash
case "\$1" in
    start)
        cd ~/xmrig
        nohup ./xmrig -c config.json > ~/miner.log 2>&1 &
        echo "âœ… MineraÃ§Ã£o iniciada"
        ;;
    stop)
        pkill -9 xmrig
        echo "ğŸ›‘ MineraÃ§Ã£o parada"
        ;;
    status)
        if pgrep xmrig >/dev/null; then
            echo "âœ… Ativa - PID: \$(pgrep xmrig)"
            tail -5 ~/miner.log 2>/dev/null | grep -E "speed|accepted"
        else
            echo "âŒ Inativa"
        fi
        ;;
    logs)
        tail -f ~/miner.log
        ;;
    *)
        echo "Uso: ./miner_control.sh {start|stop|status|logs}"
        ;;
esac
EOF

chmod +x ~/miner_control.sh

# ============= NOTIFICAR SUCESSO =============
sleep 5

if pgrep xmrig >/dev/null; then
    log "âœ… MINERAÃ‡ÃƒO INICIADA COM SUCESSO!"
    log "ğŸ“± Worker: $WORKER"
    log "ğŸ’° Carteira: $WALLET"
    log "â›ï¸ Pool: Nicehash"
    
    send_discord "âœ… MINERAÃ‡ÃƒO CONFIGURADA COM SUCESSO!
ğŸ¯ Carteira: $WALLET
ğŸ‘· Worker: $WORKER
âš¡ Hashrate: Iniciando...
ğŸ“Š Status: Ativo e minerando"
    
    # Mostrar logs iniciais
    echo ""
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "ğŸ“Š LOGS INICIAIS (Ãºltimas 3 linhas):"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    tail -3 ~/miner.log 2>/dev/null || echo "Logs iniciando..."
    
else
    err "Falha ao iniciar mineraÃ§Ã£o"
    warn "Tentando mÃ©todo alternativo..."
    cd ~/xmrig
    ./xmrig -c config.json &
fi

# ============= INFORMAÃ‡Ã•ES FINAIS =============
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "${G}âœ… SISTEMA PRONTO!${NC}"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "${B}ğŸ“‹ CONFIGURAÃ‡ÃƒO:${NC}"
echo "   Carteira: $WALLET"
echo "   Worker: $WORKER"
echo "   Pool: Nicehash ($POOL_URL)"
echo "   CPU MÃ¡x: ${MAX_CPU}%"
echo ""
echo "${B}ğŸ› ï¸ COMANDOS RÃPIDOS:${NC}"
echo "   Ver status: ./miner_control.sh status"
echo "   Parar: ./miner_control.sh stop"
echo "   Iniciar: ./miner_control.sh start"
echo "   Logs: ./miner_control.sh logs"
echo ""
echo "${B}ğŸ“Š MONITORAMENTO:${NC}"
echo "   Logs: ~/miner.log"
echo "   Discord: NotificaÃ§Ãµes ativas"
echo "   ProteÃ§Ã£o: Sistema ativo"
echo ""
echo "${Y}âš ï¸ IMPORTANTE:${NC}"
echo "   â€¢ Mantenha Termux aberto"
echo "   â€¢ Use carregador conectado"
echo "   â€¢ Monitorar temperatura"
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "${G}âš¡ Minerando para: $WALLET${NC}"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

# Manter script rodando
sleep 10
echo ""
log "Sistema minerando em background..."
log "Para ver status: ./miner_control.sh status"
