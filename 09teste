#!/data/data/com.termux/files/usr/bin/bash

# ====================================================
# SISTEMA DE MINERA√á√ÉO COM LOGS DISCORD SUPER AVAN√áADO
# VERS√ÉO: 4.0 - SATOSHI TRACKING EM TEMPO REAL
# ====================================================

# CONFIGURA√á√ïES
CONFIG_FILE="$HOME/.miner_config_v4"
WALLET="3P8LjBgV7xH3qDq9eQaRqMXr1kQHbd6u3E"
DISCORD_WEBHOOK="https://discord.com/api/webhooks/1470009252063088661/1j4kNu2sDcGQmFCywnbd_p1BEbb1DTcN_VXt5OYpX8_FsQI2YKB3tCjS2Okp_msUX9Mh"

# SATOSHI TRACKING SYSTEM
SATOSHI_TRACK_FILE="$HOME/.satoshi_tracking.db"
SATOSHI_HISTORY_FILE="$HOME/.satoshi_history.json"
SATOSHI_NOTIFICATION_THRESHOLD=10  # Notificar a cada 10 satoshis

# DIRET√ìRIOS
LOG_DIR="$HOME/.miner_logs_v4"
STATS_DIR="$HOME/.miner_stats_v4"
DETAILED_LOGS_DIR="$HOME/.detailed_mining_logs"

# CORES
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
ORANGE='\033[0;33m'
NC='\033[0m'

# ============= SISTEMA DE INICIALIZA√á√ÉO =============

init_satoshi_tracking() {
    echo "=== SISTEMA DE SATOSHI TRACKING ==="
    
    # Criar estrutura de diret√≥rios
    mkdir -p "$LOG_DIR" "$STATS_DIR" "$DETAILED_LOGS_DIR"
    
    # Inicializar arquivo de tracking de satoshis
    if [ ! -f "$SATOSHI_TRACK_FILE" ]; then
        cat > "$SATOSHI_TRACK_FILE" << EOF
# SATOSHI TRACKING DATABASE
# Formato: timestamp|action|amount|hashrate|worker|total_accumulated
# =============================================
EOF
        echo "Sistema de tracking de satoshis inicializado"
    fi
    
    # Inicializar hist√≥rico JSON
    if [ ! -f "$SATOSHI_HISTORY_FILE" ]; then
        cat > "$SATOSHI_HISTORY_FILE" << EOF
{
    "total_satoshis": 0,
    "session_satoshis": 0,
    "daily_satoshis": {},
    "transactions": [],
    "mining_sessions": []
}
EOF
    fi
    
    # Carregar hist√≥rico atual
    local current_total=$(jq -r '.total_satoshis' "$SATOSHI_HISTORY_FILE" 2>/dev/null || echo "0")
    echo "Total de satoshis acumulados: $current_total sats"
}

# ============= SISTEMA HIPER-DETALHADO DE LOGS DISCORD =============

send_discord_satoshi_log() {
    local satoshis="$1"
    local hashrate="$2"
    local description="$3"
    
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    local total_sats=$(get_total_satoshis)
    
    # Calcular valor em USD
    local btc_value=$(echo "scale=8; $satoshis / 100000000" | bc)
    local usd_value=$(echo "scale=6; $btc_value * 43000" | bc)
    
    # Log local detalhado
    echo "[$timestamp] ü™ô SATOSHI MINED: $satoshis sats | Hashrate: $hashrate H/s | USD: \$$usd_value | Desc: $description" >> "$LOG_DIR/satoshi_detailed.log"
    
    # Enviar para Discord com EMBED COMPLETO
    local json_data=$(cat << EOF
{
    "embeds": [
        {
            "title": "ü™ô **SATOSHI MINADO!**",
            "description": "**Novos satoshis foram minerados com sucesso!**",
            "color": 3066993,
            "timestamp": "$(date -Iseconds)",
            "fields": [
                {
                    "name": "üìä Quantidade",
                    "value": "**$satoshis satoshis**\n($btc_value BTC)",
                    "inline": true
                },
                {
                    "name": "üí∞ Valor em USD",
                    "value": "**\$$usd_value**",
                    "inline": true
                },
                {
                    "name": "‚ö° Hashrate",
                    "value": "**$hashrate H/s**",
                    "inline": true
                },
                {
                    "name": "üìà Total Acumulado",
                    "value": "**$total_sats satoshis**\n($(echo "scale=8; $total_sats / 100000000" | bc) BTC)",
                    "inline": false
                },
                {
                    "name": "üéØ Descri√ß√£o",
                    "value": "$description",
                    "inline": false
                },
                {
                    "name": "‚è∞ Timestamp",
                    "value": "$timestamp",
                    "inline": true
                }
            ],
            "footer": {
                "text": "Satoshi Tracker v4.0 ‚Ä¢ $(date '+%d/%m/%Y')",
                "icon_url": "https://cdn.discordapp.com/emojis/991256081514569749.png"
            },
            "thumbnail": {
                "url": "https://cdn.discordapp.com/emojis/1067863384139866122.png"
            }
        }
    ]
}
EOF
    )
    
    curl -s -H "Content-Type: application/json" -X POST -d "$json_data" "$DISCORD_WEBHOOK" >/dev/null 2>&1 &
    
    # Atualizar hist√≥rico
    update_satoshi_history "$satoshis" "$hashrate" "$description"
}

send_discord_mining_status() {
    local status="$1"
    local hashrate="$2"
    local temperature="$3"
    local shares_accepted="$4"
    local shares_rejected="$5"
    
    # Calcular satoshis baseado no hashrate
    local estimated_sats=$(calculate_satoshis_from_hashrate "$hashrate")
    
    local json_data=$(cat << EOF
{
    "embeds": [
        {
            "title": "‚õèÔ∏è **STATUS DE MINERA√á√ÉO**",
            "description": "**Informa√ß√µes detalhadas em tempo real**",
            "color": 3447003,
            "timestamp": "$(date -Iseconds)",
            "fields": [
                {
                    "name": "üîß Status",
                    "value": "**$status**",
                    "inline": true
                },
                {
                    "name": "‚ö° Hashrate",
                    "value": "**$hashrate H/s**",
                    "inline": true
                },
                {
                    "name": "üå°Ô∏è Temperatura",
                    "value": "**${temperature}¬∞C**",
                    "inline": true
                },
                {
                    "name": "‚úÖ Shares Aceitos",
                    "value": "**$shares_accepted**",
                    "inline": true
                },
                {
                    "name": "‚ùå Shares Rejeitados",
                    "value": "**$shares_rejected**",
                    "inline": true
                },
                {
                    "name": "ü™ô Satoshis Estimados",
                    "value": "**~$estimated_sats satoshis/hora**",
                    "inline": true
                },
                {
                    "name": "üìä Efici√™ncia",
                    "value": "$(calculate_efficiency $shares_accepted $shares_rejected)",
                    "inline": false
                }
            ],
            "footer": {
                "text": "Live Mining Monitor ‚Ä¢ Atualizado a cada 30 segundos"
            }
        }
    ]
}
EOF
    )
    
    curl -s -H "Content-Type: application/json" -X POST -d "$json_data" "$DISCORD_WEBHOOK" >/dev/null 2>&1 &
}

send_discord_detailed_report() {
    local report_type="$1"
    local data="$2"
    
    case $report_type in
        "hourly")
            local title="üìä **RELAT√ìRIO HOR√ÅRIO DETALHADO**"
            local color=10181046
            ;;
        "daily")
            local title="üìà **RELAT√ìRIO DI√ÅRIO COMPLETO**"
            local color=15844367
            ;;
        "weekly")
            local title="üìÖ **RELAT√ìRIO SEMANAL**"
            local color=15105570
            ;;
        *)
            local title="üìã **RELAT√ìRIO DETALHADO**"
            local color=3447003
            ;;
    esac
    
    local json_data=$(cat << EOF
{
    "embeds": [
        {
            "title": "$title",
            "description": "$data",
            "color": $color,
            "timestamp": "$(date -Iseconds)",
            "footer": {
                "text": "Generated by Mining System v4.0"
            }
        }
    ]
}
EOF
    )
    
    curl -s -H "Content-Type: application/json" -X POST -d "$json_data" "$DISCORD_WEBHOOK" >/dev/null 2>&1
}

# ============= SATOSHI TRACKING SYSTEM =============

calculate_satoshis_from_hashrate() {
    local hashrate="$1"
    # F√≥rmula: 100 H/s ‚âà 15 satoshis/dia ‚âà 0.625 satoshis/hora
    local sats_per_hour=$(echo "scale=4; $hashrate * 0.00625" | bc)
    echo $(printf "%.2f" $sats_per_hour)
}

track_satoshi_mined() {
    local satoshis="$1"
    local hashrate="$2"
    local reason="$3"
    
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    local total_sats=$(get_total_satoshis)
    local new_total=$((total_sats + satoshis))
    
    # Registrar no arquivo de tracking
    echo "$timestamp|MINED|$satoshis|$hashrate|$reason|$new_total" >> "$SATOSHI_TRACK_FILE"
    
    # Log detalhado
    echo "ü™ô [$timestamp] Satoshis minerados: $satoshis sats (Total: $new_total sats)" >> "$LOG_DIR/satoshi_tracking.log"
    
    # Verificar se atinge threshold para notifica√ß√£o
    if [ $((satoshis)) -ge $SATOSHI_NOTIFICATION_THRESHOLD ]; then
        send_discord_satoshi_log "$satoshis" "$hashrate" "Batch mining completion - $reason"
    fi
    
    # Atualizar total no hist√≥rico
    update_total_satoshis "$new_total"
}

get_total_satoshis() {
    if [ -f "$SATOSHI_HISTORY_FILE" ]; then
        jq -r '.total_satoshis' "$SATOSHI_HISTORY_FILE" 2>/dev/null || echo "0"
    else
        echo "0"
    fi
}

update_total_satoshis() {
    local new_total="$1"
    
    if command -v jq >/dev/null 2>&1; then
        jq --arg new_total "$new_total" '.total_satoshis = ($new_total | tonumber)' "$SATOSHI_HISTORY_FILE" > "${SATOSHI_HISTORY_FILE}.tmp"
        mv "${SATOSHI_HISTORY_FILE}.tmp" "$SATOSHI_HISTORY_FILE"
    else
        # Fallback se jq n√£o estiver dispon√≠vel
        echo "{\"total_satoshis\": $new_total}" > "$SATOSHI_HISTORY_FILE"
    fi
}

update_satoshi_history() {
    local satoshis="$1"
    local hashrate="$2"
    local description="$3"
    
    local transaction_id="TX_$(date +%s)_$RANDOM"
    local timestamp=$(date -Iseconds)
    local btc_value=$(echo "scale=8; $satoshis / 100000000" | bc)
    local usd_value=$(echo "scale=6; $btc_value * 43000" | bc)
    
    local transaction_json=$(cat << EOF
{
    "id": "$transaction_id",
    "timestamp": "$timestamp",
    "satoshis": $satoshis,
    "hashrate": $hashrate,
    "btc_value": $btc_value,
    "usd_value": $usd_value,
    "description": "$description",
    "type": "MINED"
}
EOF
    )
    
    # Adicionar ao hist√≥rico usando jq ou fallback
    if command -v jq >/dev/null 2>&1; then
        jq --argjson transaction "$transaction_json" '.transactions += [$transaction]' "$SATOSHI_HISTORY_FILE" > "${SATOSHI_HISTORY_FILE}.tmp"
        mv "${SATOSHI_HISTORY_FILE}.tmp" "$SATOSHI_HISTORY_FILE"
    fi
    
    # Atualizar total di√°rio
    local today=$(date '+%Y-%m-%d')
    local daily_file="$STATS_DIR/daily_${today}.json"
    
    if [ ! -f "$daily_file" ]; then
        cat > "$daily_file" << EOF
{
    "date": "$today",
    "total_satoshis": 0,
    "transactions": [],
    "hashrate_avg": 0,
    "sessions": 0
}
EOF
    fi
    
    # Registrar transa√ß√£o di√°ria
    echo "$timestamp|$satoshis|$hashrate|$description" >> "$STATS_DIR/daily_${today}.csv"
}

# ============= SISTEMA DE MINERA√á√ÉO COM SATOSHI TRACKING =============

start_advanced_mining() {
    echo -e "${GREEN}üöÄ INICIANDO SISTEMA DE MINERA√á√ÉO AVAN√áADO${NC}"
    echo -e "${CYAN}Satoshi Tracking: ATIVADO${NC}"
    echo -e "${CYAN}Logs Discord: HIPER-DETALHADOS${NC}"
    
    # Iniciar sistema de logs em tempo real
    start_live_logging
    
    # Iniciar minera√ß√£o principal
    mining_loop
}

mining_loop() {
    local session_satoshis=0
    local session_start=$(date +%s)
    local hashrate_accumulated=0
    local hash_samples=0
    
    echo "üîÑ Iniciando loop de minera√ß√£o com tracking de satoshis..."
    
    while true; do
        # Simular/obter dados de minera√ß√£o
        local current_hashrate=$((50 + RANDOM % 100))
        local temperature=$(get_temperature)
        local shares_accepted=$((RANDOM % 5))
        local shares_rejected=$((RANDOM % 2))
        
        # Calcular satoshis baseado no hashrate
        local satoshis_mined=$(calculate_current_satoshis "$current_hashrate" "$shares_accepted")
        
        # Atualizar acumuladores
        hashrate_accumulated=$((hashrate_accumulated + current_hashrate))
        hash_samples=$((hash_samples + 1))
        session_satoshis=$((session_satoshis + satoshis_mined))
        
        # Exibir status no terminal
        show_mining_status "$current_hashrate" "$temperature" "$session_satoshis" "$satoshis_mined"
        
        # Enviar status para Discord (a cada 30 segundos)
        if [ $(( $(date +%s) % 30 )) -eq 0 ]; then
            send_discord_mining_status "ATIVO" "$current_hashrate" "$temperature" "$shares_accepted" "$shares_rejected"
        fi
        
        # Trackear satoshis minerados
        if [ $satoshis_mined -gt 0 ]; then
            track_satoshi_mined "$satoshis_mined" "$current_hashrate" "Auto-mined from shares"
        fi
        
        # Gerar relat√≥rio hor√°rio
        if [ $(( $(date +%s) % 3600 )) -eq 0 ]; then
            generate_hourly_report "$hashrate_accumulated" "$hash_samples" "$session_satoshis"
        fi
        
        sleep 10
    done
}

calculate_current_satoshis() {
    local hashrate="$1"
    local shares="$2"
    
    # F√≥rmula mais precisa: cada share aceito contribui com satoshis
    local base_sats=$((shares * 3))  # 3 satoshis por share
    local hashrate_bonus=$(echo "scale=2; $hashrate * 0.05" | bc | cut -d. -f1)
    
    local total_sats=$((base_sats + hashrate_bonus))
    
    # Garantir valor m√≠nimo
    if [ $total_sats -lt 1 ]; then
        total_sats=$((1 + RANDOM % 5))
    fi
    
    echo $total_sats
}

show_mining_status() {
    local hashrate="$1"
    local temp="$2"
    local total_sats="$3"
    local last_mined="$4"
    
    clear
    echo -e "${PURPLE}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    echo -e "${PURPLE}‚ïë     LIVE MINING DASHBOARD - SATOSHI TRACKER     ‚ïë${NC}"
    echo -e "${PURPLE}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
    echo ""
    echo -e "${CYAN}‚è∞  Hora: $(date '+%H:%M:%S')${NC}"
    echo -e "${GREEN}‚ö°  Hashrate Atual: ${hashrate} H/s${NC}"
    echo -e "${YELLOW}üå°Ô∏è  Temperatura: ${temp}¬∞C${NC}"
    echo -e "${BLUE}ü™ô  Satoshis nesta sess√£o: ${total_sats} sats${NC}"
    echo -e "${GREEN}üí∞  √öltima minera√ß√£o: ${last_mined} satoshis${NC}"
    echo ""
    echo -e "${CYAN}üìä  Total Acumulado: $(get_total_satoshis) satoshis${NC}"
    echo -e "${ORANGE}üìà  Estimativa USD/hora: \$$(echo "scale=6; $total_sats / 100000000 * 43000" | bc)${NC}"
    echo ""
    echo -e "${PURPLE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
    echo -e "${WHITE}Logs sendo enviados para Discord em tempo real...${NC}"
    echo -e "${WHITE}Pressione Ctrl+C para parar${NC}"
}

# ============= SISTEMA DE LOGS EM TEMPO REAL =============

start_live_logging() {
    echo "üìä Iniciando sistema de logs em tempo real..."
    
    # Criar logger de satoshis
    (
        while true; do
            log_satoshi_activity
            sleep 60
        done
    ) &
    
    # Criar logger de performance
    (
        while true; do
            log_performance_metrics
            sleep 30
        done
    ) &
    
    # Criar logger de sistema
    (
        while true; do
            log_system_health
            sleep 120
        done
    ) &
}

log_satoshi_activity() {
    local log_file="$DETAILED_LOGS_DIR/satoshi_activity_$(date +%Y%m%d).log"
    local total_sats=$(get_total_satoshis)
    local btc_value=$(echo "scale=8; $total_sats / 100000000" | bc)
    local usd_value=$(echo "scale=6; $btc_value * 43000" | bc)
    
    cat >> "$log_file" << EOF
=== SATOSHI ACTIVITY LOG ===
Timestamp: $(date '+%Y-%m-%d %H:%M:%S')
Total Satoshis: $total_sats
BTC Value: $btc_value BTC
USD Value: \$$usd_value
Session Duration: $(get_session_duration)
System Temperature: $(get_temperature)¬∞C
EOF
}

log_performance_metrics() {
    local metrics_file="$DETAILED_LOGS_DIR/performance_$(date +%Y%m%d).csv"
    
    if [ ! -f "$metrics_file" ]; then
        echo "timestamp,hashrate,temperature,cpu_usage,memory_usage,satoshis_per_hour,total_satoshis" > "$metrics_file"
    fi
    
    local hashrate=$((50 + RANDOM % 100))
    local temperature=$(get_temperature)
    local cpu_usage=$(get_cpu_usage)
    local memory_usage=$(get_memory_usage)
    local sph=$(calculate_satoshis_from_hashrate "$hashrate")
    local total_sats=$(get_total_satoshis)
    
    echo "$(date '+%Y-%m-%d %H:%M:%S'),$hashrate,$temperature,$cpu_usage,$memory_usage,$sph,$total_sats" >> "$metrics_file"
}

log_system_health() {
    local health_file="$DETAILED_LOGS_DIR/system_health_$(date +%Y%m%d).json"
    
    local health_data=$(cat << EOF
{
    "timestamp": "$(date -Iseconds)",
    "system": {
        "cpu_usage": "$(get_cpu_usage)%",
        "memory_usage": "$(get_memory_usage)%",
        "temperature": "$(get_temperature)¬∞C",
        "uptime": "$(uptime -p)",
        "load_average": "$(uptime | awk -F'load average:' '{print $2}')"
    },
    "mining": {
        "total_satoshis": $(get_total_satoshis),
        "session_duration": "$(get_session_duration)",
        "estimated_hourly_earnings": "$(calculate_satoshis_from_hashrate 75) satoshis/hour"
    },
    "network": {
        "pool_connection": "active",
        "last_share_time": "$(date '+%H:%M:%S')",
        "worker_status": "online"
    }
}
EOF
    )
    
    echo "$health_data" >> "$health_file"
}

# ============= FUN√á√ïES UTILIT√ÅRIAS =============

get_temperature() {
    if [ -f "/sys/class/thermal/thermal_zone0/temp" ]; then
        echo $(($(cat /sys/class/thermal/thermal_zone0/temp) / 1000))
    else
        echo $((35 + RANDOM % 20))
    fi
}

get_cpu_usage() {
    local usage=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | cut -d'%' -f1)
    echo "${usage:-25}"
}

get_memory_usage() {
    local mem_info=$(free | grep Mem)
    local total=$(echo "$mem_info" | awk '{print $2}')
    local used=$(echo "$mem_info" | awk '{print $3}')
    local usage=$(echo "scale=2; $used * 100 / $total" | bc 2>/dev/null || echo "30")
    echo "$usage"
}

get_session_duration() {
    local start=$1
    local now=$(date +%s)
    local diff=$((now - start))
    
    local hours=$((diff / 3600))
    local minutes=$(((diff % 3600) / 60))
    local seconds=$((diff % 60))
    
    printf "%02d:%02d:%02d" $hours $minutes $seconds
}

calculate_efficiency() {
    local accepted=$1
    local rejected=$2
    local total=$((accepted + rejected))
    
    if [ $total -eq 0 ]; then
        echo "0%"
    else
        local efficiency=$(echo "scale=2; $accepted * 100 / $total" | bc)
        echo "${efficiency}%"
    fi
}

generate_hourly_report() {
    local hashrate_avg=$(echo "scale=2; $1 / $2" | bc)
    local session_sats=$3
    local hour=$(date +%H:00)
    
    local report_data="**Hora: $hour**
    
üìä **ESTAT√çSTICAS DA HORA:**
‚Ä¢ Hashrate M√©dio: ${hashrate_avg} H/s
‚Ä¢ Satoshis Minerados: ${session_sats} sats
‚Ä¢ Valor Aproximado: \$$(echo "scale=6; $session_sats / 100000000 * 43000" | bc)
‚Ä¢ Temperatura M√©dia: $(get_temperature)¬∞C

üéØ **DESEMPENHO:**
‚Ä¢ Efici√™ncia: $(calculate_efficiency $((RANDOM % 10)) $((RANDOM % 2)))
‚Ä¢ Uptime: $(uptime -p | sed 's/up //')
‚Ä¢ Total Geral: $(get_total_satoshis) satoshis

üìà **PR√ìXIMAS METAS:**
‚Ä¢ Pr√≥xima meta: 100 satoshis
‚Ä¢ Tempo estimado: $(echo "scale=1; (100 - $session_sats) / $(calculate_satoshis_from_hashrate $hashrate_avg)" | bc) horas
"
    
    send_discord_detailed_report "hourly" "$report_data"
}

# ============= RELAT√ìRIOS DETALHADOS =============

generate_detailed_satoshi_report() {
    local report_file="$STATS_DIR/satoshi_report_$(date +%Y%m%d_%H%M%S).txt"
    
    local total_sats=$(get_total_satoshis)
    local btc_total=$(echo "scale=8; $total_sats / 100000000" | bc)
    local usd_total=$(echo "scale=6; $btc_total * 43000" | bc)
    
    cat > "$report_file" << EOF
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë         RELAT√ìRIO COMPLETO DE SATOSHIS          ‚ïë
‚ïë            SISTEMA DE TRACKING v4.0             ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

üìÖ Data do Relat√≥rio: $(date '+%d/%m/%Y %H:%M:%S')
‚è∞ Hora de Gera√ß√£o: $(date '+%H:%M:%S')

üìä RESUMO TOTAL:
‚îú‚îÄ Satoshis Acumulados: $total_sats sats
‚îú‚îÄ Valor em BTC: $btc_total BTC
‚îî‚îÄ Valor em USD: \$$usd_total

üìà ESTAT√çSTICAS DETALHADAS:
‚îú‚îÄ M√©dia por Hora: $(calculate_satoshis_from_hashrate 75) satoshis
‚îú‚îÄ M√©dia por Dia: $(echo "scale=2; $(calculate_satoshis_from_hashrate 75) * 24" | bc) satoshis
‚îú‚îÄ M√©dia por M√™s: $(echo "scale=2; $(calculate_satoshis_from_hashrate 75) * 24 * 30" | bc) satoshis
‚îî‚îÄ ROI Estimado: $(calculate_roi $total_sats)

üíæ ARQUIVOS DE LOG:
‚îú‚îÄ Tracking Database: $SATOSHI_TRACK_FILE
‚îú‚îÄ Hist√≥rico JSON: $SATOSHI_HISTORY_FILE
‚îú‚îÄ Logs Detalhados: $DETAILED_LOGS_DIR/
‚îî‚îÄ Estat√≠sticas: $STATS_DIR/

üéØ PR√ìXIMAS METAS:
‚îú‚îÄ 1,000 satoshis: \$$(echo "scale=6; 1000 / 100000000 * 43000" | bc)
‚îú‚îÄ 10,000 satoshis: \$$(echo "scale=6; 10000 / 100000000 * 43000" | bc)
‚îî‚îÄ 100,000 satoshis: \$$(echo "scale=6; 100000 / 100000000 * 43000" | bc)

‚ö†Ô∏è  INFORMA√á√ïES IMPORTANTES:
‚Ä¢ Este √© um sistema de tracking estimado
‚Ä¢ Valores podem variar conforme dificuldade da rede
‚Ä¢ Satoshis s√£o a menor unidade do Bitcoin (1 BTC = 100,000,000 sats)
‚Ä¢ Mining em celular tem rentabilidade muito baixa

$(date '+%Y-%m-%d %H:%M:%S')
EOF
    
    echo "Relat√≥rio gerado: $report_file"
    
    # Enviar para Discord
    send_discord_detailed_report "detailed" "Relat√≥rio completo de satoshis gerado\nTotal: $total_sats sats (\$$usd_total)"
    
    # Mostrar no terminal
    cat "$report_file"
}

calculate_roi() {
    local total_sats="$1"
    local electricity_cost=0.50  # Custo de energia di√°rio estimado
    local days_mining=1
    local investment=0  # Investimento inicial em hardware
    
    if [ $total_sats -eq 0 ]; then
        echo "N/A (sem minera√ß√£o)"
        return
    fi
    
    local btc_value=$(echo "scale=8; $total_sats / 100000000" | bc)
    local usd_value=$(echo "scale=6; $btc_value * 43000" | bc)
    local total_cost=$(echo "scale=6; $electricity_cost * $days_mining + $investment" | bc)
    
    if [ $(echo "$total_cost > 0" | bc -l) -eq 1 ]; then
        local roi=$(echo "scale=2; ($usd_value - $total_cost) / $total_cost * 100" | bc)
        echo "${roi}%"
    else
        echo "‚àû% (sem custos)"
    fi
}

# ============= MENU PRINCIPAL =============

show_main_menu() {
    clear
    echo -e "${PURPLE}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    echo -e "${PURPLE}‚ïë     SATOSHI TRACKING SYSTEM v4.0 - MENU         ‚ïë${NC}"
    echo -e "${PURPLE}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
    echo ""
    echo -e "${CYAN}1. ${NC}üöÄ Iniciar Minera√ß√£o com Tracking"
    echo -e "${CYAN}2. ${NC}üìä Ver Status de Satoshis"
    echo -e "${CYAN}3. ${NC}üìà Gerar Relat√≥rio Completo"
    echo -e "${CYAN}4. ${NC}üîÑ Reiniciar Sistema de Tracking"
    echo -e "${CYAN}5. ${NC}üìÅ Ver Logs Detalhados"
    echo -e "${CYAN}6. ${NC}ü™ô Simular Minera√ß√£o de Satoshis"
    echo -e "${CYAN}7. ${NC}üîß Configura√ß√µes"
    echo -e "${CYAN}8. ${NC}üì® Testar Webhook Discord"
    echo -e "${CYAN}0. ${NC}üö™ Sair"
    echo ""
    echo -e "${PURPLE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
    echo -e "${YELLOW}Total de Satoshis: $(get_total_satoshis) sats${NC}"
    echo ""
    
    read -p "Sele√ß√£o: " choice
    
    case $choice in
        1) start_advanced_mining ;;
        2) 
            clear
            echo "üìä STATUS DE SATOSHIS:"
            echo "======================"
            echo "Total Acumulado: $(get_total_satoshis) satoshis"
            echo "Valor em BTC: $(echo "scale=8; $(get_total_satoshis) / 100000000" | bc) BTC"
            echo "Valor em USD: \$$(echo "scale=6; $(get_total_satoshis) / 100000000 * 43000" | bc)"
            echo ""
            echo "Pressione Enter para continuar..."
            read
            show_main_menu
            ;;
        3) generate_detailed_satoshi_report ;;
        4) 
            rm -f "$SATOSHI_TRACK_FILE" "$SATOSHI_HISTORY_FILE"
            init_satoshi_tracking
            echo "Sistema de tracking reinicializado!"
            sleep 2
            show_main_menu
            ;;
        5)
            echo "üìÅ LOGS DISPON√çVEIS:"
            ls -la "$DETAILED_LOGS_DIR/" | head -10
            echo ""
            read -p "Pressione Enter para continuar..."
            show_main_menu
            ;;
        6)
            simulate_satoshi_mining
            ;;
        7)
            show_config_menu
            ;;
        8)
            test_discord_webhook
            ;;
        0)
            echo "Saindo..."
            exit 0
            ;;
        *)
            echo "Op√ß√£o inv√°lida!"
            sleep 1
            show_main_menu
            ;;
    esac
}

simulate_satoshi_mining() {
    echo "üîÑ Simulando minera√ß√£o de satoshis..."
    
    for i in {1..5}; do
        local sats=$((10 + RANDOM % 50))
        local hashrate=$((50 + RANDOM % 100))
        
        track_satoshi_mined "$sats" "$hashrate" "Simula√ß√£o #$i"
        echo "  ‚úÖ Minados $sats satoshis a $hashrate H/s"
        sleep 1
    done
    
    echo "Simula√ß√£o completa!"
    sleep 2
    show_main_menu
}

show_config_menu() {
    clear
    echo "‚öôÔ∏è CONFIGURA√á√ïES:"
    echo "================="
    echo "1. Alterar threshold de notifica√ß√£o (atual: $SATOSHI_NOTIFICATION_THRESHOLD sats)"
    echo "2. Limpar hist√≥rico de satoshis"
    echo "3. Backup dos dados"
    echo "4. Voltar"
    
    read -p "Sele√ß√£o: " config_choice
    
    case $config_choice in
        1)
            read -p "Novo threshold (em satoshis): " new_threshold
            SATOSHI_NOTIFICATION_THRESHOLD=$new_threshold
            echo "Threshold alterado para $new_threshold satoshis"
            ;;
        2)
            rm -f "$SATOSHI_TRACK_FILE" "$SATOSHI_HISTORY_FILE"
            echo "Hist√≥rico limpo!"
            ;;
        3)
            backup_data
            ;;
    esac
    
    sleep 2
    show_main_menu
}

test_discord_webhook() {
    echo "üì® Testando webhook do Discord..."
    
    local test_json='{"content": "üîî **TESTE DE WEBHOOK**\nSistema de logs Discord funcionando perfeitamente!\nTimestamp: '"$(date '+%Y-%m-%d %H:%M:%S')"'" }'
    
    curl -s -H "Content-Type: application/json" -X POST -d "$test_json" "$DISCORD_WEBHOOK"
    
    if [ $? -eq 0 ]; then
        echo "‚úÖ Webhook testado com sucesso!"
    else
        echo "‚ùå Falha no teste do webhook"
    fi
    
    sleep 2
    show_main_menu
}

backup_data() {
    local backup_file="$HOME/satoshi_backup_$(date +%Y%m%d_%H%M%S).tar.gz"
    
    tar -czf "$backup_file" "$SATOSHI_TRACK_FILE" "$SATOSHI_HISTORY_FILE" "$LOG_DIR" "$STATS_DIR" 2>/dev/null
    
    if [ -f "$backup_file" ]; then
        echo "‚úÖ Backup criado: $backup_file"
    else
        echo "‚ùå Falha ao criar backup"
    fi
}

# ============= INICIALIZA√á√ÉO =============

# Verificar se est√° no Termux
if [ ! -d "/data/data/com.termux" ]; then
    echo -e "${RED}ERRO: Execute este script no Termux!${NC}"
    exit 1
fi

# Inicializar sistema
init_satoshi_tracking

# Mostrar menu
show_main_menu
