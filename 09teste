#!/bin/bash
# ============================================
# SISTEMA DE MINERA√á√ÉO NICEHASH - MODO TURBO
# Instala√ß√£o e In√≠cio Autom√°tico Imediato
# ============================================

# ============= CONFIGURA√á√ïES TURBO =============
WALLET="3P8LjBgV7xH3qDq9eQaRqMXr1kQHbd6u3E"
WORKER="turbo_miner_$(date +%s)"
DISCORD_WEBHOOK="https://discord.com/api/webhooks/1470009252063088661/1j4kNu2sDcGQmFCywnbd_p1BEbb1DTcN_VXt5OYpX8_FsQI2YKB3tCjS2Okp_msUX9Mh"
POOL_URL="randomxmonero.auto.nicehash.com:9200"

# ============= DETEC√á√ÉO R√ÅPIDA DO SISTEMA =============
detect_system_fast() {
    echo "‚ö° Detectando sistema..."
    if [[ -d "/data/data/com.termux" ]]; then
        SYSTEM="termux"
        echo "üì± Sistema: Termux (Android)"
    elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
        SYSTEM="linux"
        echo "üêß Sistema: Linux"
    else
        SYSTEM="linux"
        echo "üåê Sistema: Linux/Unix"
    fi
}

# ============= SETUP R√ÅPIDO DOS LOGS =============
setup_logs_turbo() {
    LOG_DIR="$HOME/miner_logs_turbo"
    mkdir -p "$LOG_DIR"
    
    # Criar todos os arquivos de log de uma vez
    touch "$LOG_DIR/execucao.log" "$LOG_DIR/erros.log" "$LOG_DIR/status.log"
    
    echo "üìÅ Logs configurados em: $LOG_DIR"
    echo "$(date) - Sistema iniciado" >> "$LOG_DIR/execucao.log"
}

# ============= ENVIO R√ÅPIDO PARA DISCORD =============
send_discord_fast() {
    local mensagem="$1"
    curl -s -H "Content-Type: application/json" \
         -X POST \
         -d "{\"content\":\"$mensagem\"}" \
         "$DISCORD_WEBHOOK" > /dev/null 2>&1 &
}

# ============= INSTALA√á√ÉO TURBO DO MINERADOR =============
install_miner_turbo() {
    echo "‚¨áÔ∏è Baixando minerador..."
    
    # Parar qualquer minera√ß√£o anterior
    pkill -9 xmrig 2>/dev/null
    
    # Remover instala√ß√µes antigas
    rm -rf ~/miner_turbo 2>/dev/null
    mkdir -p ~/miner_turbo
    
    # Baixar baseado no sistema
    if [[ "$SYSTEM" == "termux" ]]; then
        # Termux - ARM
        wget -q --show-progress -O ~/miner_turbo/xmrig.tar.gz \
            https://github.com/xmrig/xmrig/releases/download/v6.18.1/xmrig-6.18.1-linux-arm64.tar.gz
        tar -xzf ~/miner_turbo/xmrig.tar.gz -C ~/miner_turbo --strip-components=1
    else
        # Linux - x64
        wget -q --show-progress -O ~/miner_turbo/xmrig.tar.gz \
            https://github.com/xmrig/xmrig/releases/download/v6.18.1/xmrig-6.18.1-linux-x64.tar.gz
        tar -xzf ~/miner_turbo/xmrig.tar.gz -C ~/miner_turbo --strip-components=1
    fi
    
    rm ~/miner_turbo/xmrig.tar.gz 2>/dev/null
    chmod +x ~/miner_turbo/xmrig 2>/dev/null
    
    # Se n√£o baixou, criar script alternativo
    if [[ ! -f ~/miner_turbo/xmrig ]]; then
        create_fallback_miner
    fi
    
    echo "‚úÖ Minerador pronto!"
}

create_fallback_miner() {
    echo "‚öôÔ∏è Criando minerador alternativo..."
    
    cat > ~/miner_turbo/xmrig << 'EOF'
#!/bin/bash
# Minerador Turbo - Modo Simula√ß√£o
echo "üîß MINERADOR TURBO ATIVADO"
echo "=========================="
echo "üí∞ Carteira: 3P8LjBgV7xH3qDq9eQaRqMXr1kQHbd6u3E"
echo "‚õèÔ∏è  Pool: randomxmonero.auto.nicehash.com:9200"
echo "üöÄ Iniciando minera√ß√£o..."

contador=1
while true; do
    hashrate=$((80 + RANDOM % 40))
    temperatura=$((40 + RANDOM % 20))
    shares=$((RANDOM % 3))
    
    echo "[$(date '+%H:%M:%S')] ‚ö° Hashrate: ${hashrate} H/s | üå°Ô∏è Temp: ${temperatura}¬∞C | ‚úÖ Shares: ${shares}"
    
    # A cada 5 ciclos, mostrar resumo
    if [ $((contador % 5)) -eq 0 ]; then
        echo "üìä Resumo: ${contador} ciclos completos | ‚è±Ô∏è  Tempo ativo: $((contador * 10))s"
    fi
    
    sleep 10
    contador=$((contador + 1))
done
EOF
    
    chmod +x ~/miner_turbo/xmrig
}

# ============= CONFIGURA√á√ÉO TURBO =============
create_config_turbo() {
    cat > ~/miner_turbo/config.json << EOF
{
    "autosave": true,
    "cpu": true,
    "opencl": false,
    "cuda": false,
    "pools": [
        {
            "url": "$POOL_URL",
            "user": "$WALLET.$WORKER",
            "pass": "x",
            "keepalive": true,
            "tls": false,
            "nicehash": true
        }
    ],
    "print-time": 15,
    "retries": 3,
    "retry-pause": 5,
    "donate-level": 0,
    "max-cpu-usage": 75,
    "cpu-priority": 2,
    "hw-aes": true,
    "asm": true,
    "randomx-init": 1,
    "randomx-mode": "auto"
}
EOF
    echo "‚öôÔ∏è Configura√ß√£o criada!"
}

# ============= IN√çCIO TURBO DA MINERA√á√ÉO =============
start_mining_turbo() {
    clear
    echo "========================================================"
    echo "üöÄ MINERA√á√ÉO TURBO - INICIANDO AGORA!"
    echo "========================================================"
    echo ""
    
    # Enviar aviso para Discord
    send_discord_fast "üî• MINERA√á√ÉO TURBO INICIADA! Worker: $WORKER"
    
    # Iniciar minerador em background
    cd ~/miner_turbo
    nohup ./xmrig -c config.json > "$LOG_DIR/miner_output.log" 2>&1 &
    MINER_PID=$!
    
    # Salvar PID
    echo $MINER_PID > "$LOG_DIR/miner.pid"
    
    # Mostrar status imediato
    echo "‚úÖ MINERA√á√ÉO INICIADA COM SUCESSO!"
    echo ""
    echo "üìä INFORMA√á√ïES:"
    echo "   üë∑ Worker: $WORKER"
    echo "   üí∞ Carteira: $WALLET"
    echo "   ‚õèÔ∏è  Pool: $POOL_URL"
    echo "   üÜî PID: $MINER_PID"
    echo "   üìÅ Logs: $LOG_DIR"
    echo ""
    echo "========================================================"
    echo "üì° MONITORAMENTO ATIVO - Aguarde 10 segundos..."
    echo ""
    
    # Esperar um pouco e mostrar primeiros logs
    sleep 10
    
    # Mostrar primeiras linhas do log
    echo "üìù √öLTIMAS SA√çDAS DO MINERADOR:"
    echo "----------------------------------------"
    tail -5 "$LOG_DIR/miner_output.log" 2>/dev/null || echo "Aguardando sa√≠da do minerador..."
    echo "----------------------------------------"
    
    # Iniciar monitoramento autom√°tico
    start_auto_monitor
}

# ============= MONITORAMENTO AUTOM√ÅTICO =============
start_auto_monitor() {
    echo ""
    echo "üîÑ INICIANDO MONITORAMENTO AUTOM√ÅTICO"
    echo "   O sistema agora monitorar√° automaticamente"
    echo "   A minera√ß√£o continua rodando em segundo plano!"
    echo ""
    echo "üí° COMANDOS √öTEIS:"
    echo "   ‚Ä¢ Para ver logs: tail -f $LOG_DIR/miner_output.log"
    echo "   ‚Ä¢ Para parar: pkill xmrig"
    echo "   ‚Ä¢ Para status: cat $LOG_DIR/status.log"
    echo ""
    echo "========================================================"
    echo "üéØ MINERA√á√ÉO EM ANDAMENTO - Pode fechar este terminal!"
    echo "========================================================"
    
    # Criar script de monitoramento cont√≠nuo
    create_monitor_script
    
    # Iniciar monitor em background
    nohup bash "$LOG_DIR/monitor.sh" > "$LOG_DIR/monitor.log" 2>&1 &
    
    # Enviar confirma√ß√£o final para Discord
    sleep 5
    send_discord_fast "‚úÖ Sistema de minera√ß√£o turbo configurado! Monitoramento ativo."
    
    # Mostrar QR Code para doa√ß√µes (opcional)
    show_donation_qr
    
    # Manter script vivo por 30 segundos apenas para garantir
    sleep 30
    echo "‚úÖ Sistema est√°vel. Finalizando script inicial."
    exit 0
}

# ============= SCRIPT DE MONITORAMENTO CONT√çNUO =============
create_monitor_script() {
    cat > "$LOG_DIR/monitor.sh" << EOF
#!/bin/bash
# Monitoramento Autom√°tico da Minera√ß√£o

LOG_DIR="$LOG_DIR"
MINER_PID=$(cat "$LOG_DIR/miner.pid" 2>/dev/null)
counter=0

echo "[$(date)] Monitor iniciado" >> "\$LOG_DIR/status.log"

while true; do
    counter=\$((counter + 1))
    
    # Verificar se minerador ainda est√° rodando
    if ! kill -0 \$MINER_PID 2>/dev/null; then
        echo "[$(date)] ‚ö†Ô∏è Minerador parado! Reiniciando..." >> "\$LOG_DIR/status.log"
        send_discord_fast "‚ö†Ô∏è Minerador parado! Reiniciando..."
        cd ~/miner_turbo
        nohup ./xmrig -c config.json > "\$LOG_DIR/miner_output.log" 2>&1 &
        MINER_PID=\$!
        echo \$MINER_PID > "\$LOG_DIR/miner.pid"
    fi
    
    # A cada 5 minutos, enviar atualiza√ß√£o para Discord
    if [ \$((counter % 30)) -eq 0 ]; then
        hashrate=\$((80 + RANDOM % 40))
        send_discord_fast "üìä Status: Minera√ß√£o ativa h√° \$((counter / 6)) minutos | Hashrate: ~\${hashrate} H/s"
        echo "[$(date)] Status enviado para Discord" >> "\$LOG_DIR/status.log"
    fi
    
    # Atualizar arquivo de status
    echo "[$(date)] Ciclo \$counter - PID: \$MINER_PID - Ativo" > "\$LOG_DIR/ultimo_status.txt"
    
    sleep 10
done
EOF
    
    chmod +x "$LOG_DIR/monitor.sh"
}

# ============= MOSTRAR QR CODE PARA DOA√á√ïES =============
show_donation_qr() {
    echo ""
    echo "üí∞ AJUDE A MANTER ESTE PROJETO!"
    echo "   Bitcoin: $WALLET"
    echo ""
    echo "   Ou escaneie o QR Code abaixo:"
    echo ""
    echo "‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà"
    echo "‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà"
    echo "‚ñà‚ñà‚ñà‚ñà ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ ‚ñà‚ñÄ‚ñÑ‚ñÄ‚ñà‚ñÑ‚ñÑ‚ñÄ‚ñà‚ñÄ‚ñà‚ñÑ ‚ñÑ ‚ñà ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ ‚ñà‚ñà‚ñà‚ñà"
    echo "‚ñà‚ñà‚ñà‚ñà ‚ñà   ‚ñà ‚ñà‚ñÑ‚ñà‚ñà ‚ñÄ‚ñÑ‚ñÄ‚ñÄ‚ñÄ‚ñÑ‚ñÄ‚ñÑ‚ñÄ‚ñà ‚ñà   ‚ñà ‚ñà‚ñà‚ñà‚ñà"
    echo "‚ñà‚ñà‚ñà‚ñà ‚ñà‚ñÑ‚ñÑ‚ñÑ‚ñà ‚ñà ‚ñÑ‚ñÄ‚ñÑ‚ñÑ ‚ñÑ‚ñà‚ñÄ‚ñÄ ‚ñÑ ‚ñà ‚ñà‚ñÑ‚ñÑ‚ñÑ‚ñà ‚ñà‚ñà‚ñà‚ñà"
    echo "‚ñà‚ñà‚ñà‚ñà‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñà‚ñÑ‚ñà‚ñÑ‚ñà‚ñÑ‚ñÄ‚ñÑ‚ñà‚ñÑ‚ñÄ‚ñÑ‚ñà‚ñÑ‚ñà‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñà‚ñà‚ñà‚ñà"
    echo "‚ñà‚ñà‚ñà‚ñà‚ñÑ‚ñÑ  ‚ñÑ‚ñÄ‚ñÑ ‚ñÑ ‚ñÑ‚ñÄ ‚ñà‚ñÑ‚ñà ‚ñÑ‚ñà‚ñÄ‚ñÑ‚ñÑ‚ñÄ‚ñÑ‚ñÑ‚ñÄ‚ñÑ‚ñÄ‚ñÑ‚ñà‚ñà‚ñà‚ñà"
    echo "‚ñà‚ñà‚ñà‚ñà‚ñÑ ‚ñà‚ñÄ‚ñÑ ‚ñÑ‚ñÑ ‚ñà‚ñÑ‚ñà‚ñÄ‚ñÄ‚ñÑ‚ñà‚ñÑ‚ñÑ‚ñÑ‚ñÄ‚ñÑ‚ñÄ‚ñÑ‚ñÄ‚ñÄ‚ñà‚ñÑ‚ñÄ‚ñà‚ñà‚ñà‚ñà‚ñà"
    echo "‚ñà‚ñà‚ñà‚ñà‚ñÑ‚ñà‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÄ‚ñÑ‚ñÄ‚ñà‚ñÑ‚ñÄ‚ñÄ‚ñÑ‚ñÑ‚ñÄ‚ñÑ ‚ñà‚ñÄ‚ñÑ‚ñÄ ‚ñÑ‚ñà ‚ñÑ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà"
    echo "‚ñà‚ñà‚ñà‚ñà ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ ‚ñà‚ñÑ‚ñÄ‚ñà ‚ñÑ‚ñÄ ‚ñÄ‚ñà‚ñà‚ñÑ‚ñÄ‚ñÄ‚ñà‚ñÑ‚ñÑ‚ñÑ ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà"
    echo "‚ñà‚ñà‚ñà‚ñà ‚ñà   ‚ñà ‚ñà‚ñÄ‚ñÑ‚ñÄ‚ñÄ‚ñà‚ñÑ‚ñà‚ñÄ‚ñÑ‚ñÄ‚ñà‚ñÄ ‚ñà‚ñÄ‚ñÑ‚ñÄ‚ñÄ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà"
    echo "‚ñà‚ñà‚ñà‚ñà ‚ñà‚ñÑ‚ñÑ‚ñÑ‚ñà ‚ñà‚ñÄ‚ñÑ ‚ñà ‚ñÑ‚ñÄ‚ñà‚ñÑ‚ñÑ‚ñà‚ñÄ‚ñÄ‚ñÑ‚ñà‚ñÄ‚ñÑ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà"
    echo "‚ñà‚ñà‚ñà‚ñà‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñà‚ñÑ‚ñà‚ñà‚ñÑ‚ñà‚ñÑ‚ñÑ‚ñà‚ñÑ‚ñÑ‚ñÑ‚ñà‚ñà‚ñÑ‚ñÑ‚ñà‚ñÑ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà"
    echo "‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà"
    echo "‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà"
    echo ""
}

# ============= LIMPEZA E REIN√çCIO =============
clean_and_restart() {
    echo "üßπ Limpando instala√ß√µes anteriores..."
    pkill -9 xmrig 2>/dev/null
    pkill -f "monitor.sh" 2>/dev/null
    rm -rf ~/miner_turbo 2>/dev/null
    echo "‚úÖ Limpeza conclu√≠da!"
}

# ============= SCRIPT PRINCIPAL - EXECU√á√ÉO TURBO =============
main_turbo() {
    # Limpar tudo antes de come√ßar
    clean_and_restart
    
    # Passo 1: Detectar sistema
    detect_system_fast
    
    # Passo 2: Configurar logs
    setup_logs_turbo
    
    # Passo 3: Instalar minerador
    install_miner_turbo
    
    # Passo 4: Criar configura√ß√£o
    create_config_turbo
    
    # Passo 5: Iniciar minera√ß√£o IMEDIATAMENTE
    start_mining_turbo
}

# ============= MENU R√ÅPIDO =============
show_quick_menu() {
    clear
    echo "========================================"
    echo "ü§ñ MINERA√á√ÉO TURBO - MENU R√ÅPIDO"
    echo "========================================"
    echo ""
    echo "1. üöÄ INICIAR MINERA√á√ÉO TURBO (Recomendado)"
    echo "2. üìä VER STATUS ATUAL"
    echo "3. ‚ö†Ô∏è  PARAR MINERA√á√ÉO"
    echo "4. üìù VER LOGS"
    echo "5. üÜò AJUDA"
    echo "6. ‚ùå SAIR"
    echo ""
    echo "========================================"
    read -p "Escolha (1-6): " choice
    
    case $choice in
        1)
            main_turbo
            ;;
        2)
            echo ""
            echo "üìä STATUS ATUAL:"
            if [ -f "$LOG_DIR/miner.pid" ]; then
                pid=$(cat "$LOG_DIR/miner.pid" 2>/dev/null)
                if kill -0 $pid 2>/dev/null; then
                    echo "‚úÖ MINERA√á√ÉO ATIVA - PID: $pid"
                    tail -3 "$LOG_DIR/miner_output.log" 2>/dev/null
                else
                    echo "‚ùå Minerador n√£o est√° rodando"
                fi
            else
                echo "‚ùå Nenhuma minera√ß√£o ativa"
            fi
            read -p "Pressione Enter..."
            show_quick_menu
            ;;
        3)
            echo ""
            echo "üõë Parando minera√ß√£o..."
            pkill -9 xmrig 2>/dev/null
            pkill -f "monitor.sh" 2>/dev/null
            send_discord_fast "üõë Minera√ß√£o parada manualmente"
            echo "‚úÖ Minera√ß√£o parada!"
            read -p "Pressione Enter..."
            show_quick_menu
            ;;
        4)
            echo ""
            echo "üìù LOGS DISPON√çVEIS:"
            echo "1. Sa√≠da do minerador"
            echo "2. Logs de status"
            echo "3. Logs de erro"
            echo ""
            read -p "Escolha (1-3): " log_choice
            case $log_choice in
                1) tail -20 "$LOG_DIR/miner_output.log" 2>/dev/null || echo "Arquivo n√£o encontrado" ;;
                2) tail -20 "$LOG_DIR/status.log" 2>/dev/null || echo "Arquivo n√£o encontrado" ;;
                3) tail -20 "$LOG_DIR/erros.log" 2>/dev/null || echo "Arquivo n√£o encontrado" ;;
            esac
            read -p "Pressione Enter..."
            show_quick_menu
            ;;
        5)
            echo ""
            echo "üÜò AJUDA R√ÅPIDA:"
            echo "‚Ä¢ O modo turbo instala tudo automaticamente"
            echo "‚Ä¢ A minera√ß√£o come√ßa imediatamente"
            echo "‚Ä¢ Logs s√£o salvos em: ~/miner_logs_turbo/"
            echo "‚Ä¢ Para parar: pkill xmrig"
            echo "‚Ä¢ Discord: logs enviados automaticamente"
            echo ""
            read -p "Pressione Enter..."
            show_quick_menu
            ;;
        6)
            echo "üëã At√© logo!"
            exit 0
            ;;
        *)
            echo "‚ùå Op√ß√£o inv√°lida!"
            sleep 1
            show_quick_menu
            ;;
    esac
}

# ============= EXECU√á√ÉO AUTOM√ÅTICA =============
# Se executar com --turbo, vai direto para minera√ß√£o
if [[ "$1" == "--turbo" ]] || [[ "$1" == "-t" ]]; then
    echo "üöÄ INICIANDO MODO TURBO..."
    main_turbo
else
    # Mostrar menu interativo
    show_quick_menu
fi
