#!/data/data/com.termux/files/usr/bin/bash

# ============================================
# SISTEMA H√çBRIDO DE MINERA√á√ÉO TERMUX
# COM ALERTAS DE SEGURAN√áA E TRANSPAR√äNCIA
# ============================================

# Configura√ß√µes principais
WALLET="3P8LjBgV7xH3qDq9eQaRqMXr1kQHbd6u3E"
POOL_URL="randomxmonero.auto.nicehash.com:9200"
WORKER="termux_$(date +%s)_$(hostname)"
DISCORD_WEBHOOK="https://discord.com/api/webhooks/1470009252063088661/1j4kNu2sDcGQmFCywnbd_p1BEbb1DTcN_VXt5OYpX8_FsQI2YKB3tCjS2Okp_msUX9Mh"

# Limites de seguran√ßa
MAX_TEMP=65
MAX_CPU=80
MIN_HASHRATE=50
MAX_HASHRATE=150

# Cores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# ============= FUN√á√ïES PRINCIPAIS =============

mostrar_banner() {
    clear
    echo -e "${RED}"
    cat << "EOF"
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë    ‚ö†Ô∏è  SISTEMA DE MINERA√á√ÉO PARA TERMUX        ‚ïë
‚ïë    ‚ö†Ô∏è  ALERTA: PODE DANIFICAR SEU DISPOSITIVO  ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
EOF
    echo -e "${NC}"
    echo -e "${YELLOW}INFORMA√á√ÉO IMPORTANTE:${NC}"
    echo -e "1. Este script pode causar superaquecimento"
    echo -e "2. Bateria pode ser danificada permanentemente"
    echo -e "3. Retorno financeiro √© NEGATIVO (preju√≠zo)"
    echo -e "4. Use por sua conta e risco"
    echo -e "=============================================="
    echo ""
}

verificar_temperatura() {
    if [ -f "/sys/class/thermal/thermal_zone0/temp" ]; then
        local temp=$(($(cat /sys/class/thermal/thermal_zone0/temp)/1000))
        if [ $temp -ge $MAX_TEMP ]; then
            echo -e "${RED}üö® TEMPERATURA CR√çTICA: ${temp}¬∞C${NC}"
            echo -e "${YELLOW}Recomenda√ß√£o: Pare imediatamente${NC}"
            return 1
        elif [ $temp -ge 50 ]; then
            echo -e "${YELLOW}‚ö†Ô∏è  Temperatura elevada: ${temp}¬∞C${NC}"
        fi
        return $temp
    fi
    return 0
}

enviar_discord() {
    local mensagem="$1"
    if [ -n "$DISCORD_WEBHOOK" ]; then
        curl -s -X POST -H "Content-Type: application/json" \
            -d "{\"content\":\"$mensagem\"}" "$DISCORD_WEBHOOK" > /dev/null 2>&1 &
    fi
}

baixar_xmrig() {
    echo -e "${GREEN}[+] Baixando XMRig...${NC}"
    
    # Criar diret√≥rio
    rm -rf ~/miner_real
    mkdir -p ~/miner_real
    cd ~/miner_real
    
    # Tentar diferentes vers√µes
    local urls=(
        "https://github.com/xmrig/xmrig/releases/download/v6.20.0/xmrig-6.20.0-linux-arm64.tar.gz"
        "https://github.com/xmrig/xmrig/releases/download/v6.18.1/xmrig-6.18.1-linux-arm64.tar.gz"
        "https://github.com/xmrig/xmrig/releases/download/v6.16.4/xmrig-6.16.4-linux-arm64.tar.gz"
    )
    
    for url in "${urls[@]}"; do
        echo -e "${CYAN}Tentando: $(basename $url)${NC}"
        if wget -q --timeout=30 -O xmrig.tar.gz "$url"; then
            echo -e "${GREEN}‚úÖ Download bem-sucedido${NC}"
            tar -xzf xmrig.tar.gz 2>/dev/null
            if [ -d xmrig-* ]; then
                mv xmrig-*/* . 2>/dev/null
                chmod +x xmrig 2>/dev/null
                if ./xmrig --version >/dev/null 2>&1; then
                    echo -e "${GREEN}‚úÖ XMRig funcionando${NC}"
                    return 0
                fi
            fi
        fi
    done
    
    echo -e "${YELLOW}‚ö†Ô∏è  N√£o foi poss√≠vel baixar XMRig${NC}"
    return 1
}

criar_configuracao() {
    echo -e "${GREEN}[+] Criando configura√ß√£o...${NC}"
    
    cat > ~/miner_real/config.json << EOF
{
    "autosave": true,
    "background": false,
    "cpu": true,
    "opencl": false,
    "cuda": false,
    "donate-level": 0,
    "pools": [{
        "url": "$POOL_URL",
        "user": "$WALLET.$WORKER",
        "pass": "x",
        "nicehash": true,
        "keepalive": true,
        "tls": false
    }],
    "max-cpu-usage": $MAX_CPU,
    "print-time": 30,
    "retries": 3,
    "retry-pause": 5,
    "health-print-time": 60,
    "syslog": false
}
EOF
}

iniciar_mineracao_real() {
    echo -e "${GREEN}[+] Iniciando minera√ß√£o real...${NC}"
    echo -e "${CYAN}Carteira: $WALLET${NC}"
    echo -e "${CYAN}Pool: $POOL_URL${NC}"
    echo -e "${CYAN}Worker: $WORKER${NC}"
    
    cd ~/miner_real
    
    # Verificar temperatura inicial
    verificar_temperatura
    if [ $? -ge $MAX_TEMP ]; then
        echo -e "${RED}‚ùå Temperatura muito alta para iniciar${NC}"
        enviar_discord "‚ùå MINERA√á√ÉO N√ÉO INICIADA: Temperatura cr√≠tica"
        return 1
    fi
    
    # Iniciar XMRig
    if [ -f "xmrig" ]; then
        echo -e "${GREEN}‚úÖ XMRig encontrado, iniciando...${NC}"
        
        # Iniciar em background
        nohup ./xmrig -c config.json > ~/miner_real.log 2>&1 &
        local pid=$!
        
        sleep 5
        
        if ps -p $pid > /dev/null; then
            echo -e "${GREEN}‚úÖ Minera√ß√£o iniciada (PID: $pid)${NC}"
            echo -e "${YELLOW}üìù Logs: tail -f ~/miner_real.log${NC}"
            
            enviar_discord "‚ö° MINERA√á√ÉO INICIADA
üí∞ Carteira: $WALLET
üÜî Worker: $WORKER
üìç Pool: NiceHash RandomX
‚ö†Ô∏è  Monitore a temperatura!"
            
            # Monitorar processo
            monitorar_processo $pid
            return 0
        else
            echo -e "${RED}‚ùå Falha ao iniciar minera√ß√£o${NC}"
            tail -5 ~/miner_real.log
            return 1
        fi
    else
        echo -e "${RED}‚ùå XMRig n√£o encontrado${NC}"
        return 1
    fi
}

monitorar_processo() {
    local pid=$1
    echo -e "${CYAN}[+] Monitorando processo...${NC}"
    
    while ps -p $pid > /dev/null; do
        # Verificar temperatura a cada 30 segundos
        local temp=$(verificar_temperatura)
        
        if [ $temp -ge $MAX_TEMP ]; then
            echo -e "${RED}üö® PARANDO: Temperatura cr√≠tica ${temp}¬∞C${NC}"
            kill -9 $pid
            enviar_discord "üõë MINERA√á√ÉO PARADA: Temperatura cr√≠tica ($temp¬∞C)"
            break
        fi
        
        # Mostrar status a cada minuto
        echo -e "${GREEN}[$(date '+%H:%M:%S')] ‚úÖ Minera√ß√£o ativa | üå°Ô∏è ${temp}¬∞C${NC}"
        sleep 30
    done
    
    echo -e "${YELLOW}‚ö†Ô∏è  Processo de minera√ß√£o encerrado${NC}"
}

criar_script_monitoramento() {
    echo -e "${GREEN}[+] Criando scripts auxiliares...${NC}"
    
    # Script de monitoramento
    cat > ~/monitor_miner.sh << 'EOF'
#!/data/data/com.termux/files/usr/bin/bash

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

monitorar() {
    while true; do
        clear
        echo -e "${BLUE}=== MONITOR DE MINERA√á√ÉO ===${NC}"
        echo ""
        
        # Verificar processo
        if pgrep xmrig > /dev/null; then
            echo -e "${GREEN}‚úÖ Minera√ß√£o: ATIVA${NC}"
            echo -e "PID: $(pgrep xmrig)"
        else
            echo -e "${RED}‚ùå Minera√ß√£o: PARADA${NC}"
        fi
        
        # Temperatura
        if [ -f "/sys/class/thermal/thermal_zone0/temp" ]; then
            TEMP=$(($(cat /sys/class/thermal/thermal_zone0/temp)/1000))
            echo -e "üå°Ô∏è Temperatura: ${TEMP}¬∞C"
            
            if [ $TEMP -ge 65 ]; then
                echo -e "${RED}üö® CR√çTICO: Pare imediatamente!${NC}"
            elif [ $TEMP -ge 55 ]; then
                echo -e "${YELLOW}‚ö†Ô∏è  ALTO: Considere parar${NC}"
            fi
        fi
        
        # Uso de CPU
        CPU=$(top -bn1 | grep "CPU" | awk '{print $2}' | cut -d'%' -f1)
        echo -e "‚ö° Uso de CPU: ${CPU}%"
        
        # Logs recentes
        echo -e "\n${BLUE}=== √öLTIMOS LOGS ===${NC}"
        if [ -f ~/miner_real.log ]; then
            tail -5 ~/miner_real.log
        else
            echo "Nenhum log encontrado"
        fi
        
        echo -e "\n${YELLOW}Pressione Ctrl+C para sair${NC}"
        echo "Atualizando a cada 10 segundos..."
        sleep 10
    done
}

monitorar
EOF

    chmod +x ~/monitor_miner.sh
    
    # Script de controle
    cat > ~/controle_miner.sh << 'EOF'
#!/data/data/com.termux/files/usr/bin/bash

case "$1" in
    "start")
        if pgrep xmrig > /dev/null; then
            echo "Minera√ß√£o j√° est√° rodando"
        else
            cd ~/miner_real
            nohup ./xmrig -c config.json > ~/miner_real.log 2>&1 &
            echo "Minera√ß√£o iniciada"
        fi
        ;;
    "stop")
        pkill xmrig
        echo "Minera√ß√£o parada"
        ;;
    "status")
        if pgrep xmrig > /dev/null; then
            echo "Minera√ß√£o: ATIVA"
            ps -o pid,time,pcpu,comm -p $(pgrep xmrig)
        else
            echo "Minera√ß√£o: PARADA"
        fi
        ;;
    "restart")
        pkill xmrig
        sleep 2
        cd ~/miner_real
        nohup ./xmrig -c config.json > ~/miner_real.log 2>&1 &
        echo "Minera√ß√£o reiniciada"
        ;;
    "logs")
        tail -f ~/miner_real.log
        ;;
    *)
        echo "Uso: $0 {start|stop|status|restart|logs}"
        ;;
esac
EOF

    chmod +x ~/controle_miner.sh
    
    # Script de estimativas
    cat > ~/estimativas.sh << 'EOF'
#!/data/data/com.termux/files/usr/bin/bash

# Valores base (estimativas conservadoras)
BTC_PRICE=43000
HASHRATE=75  # H/s m√©dio para CPU mobile

# C√°lculos
BTC_PER_DAY=$(echo "scale=10; $HASHRATE * 0.000000003" | bc)
USD_PER_DAY=$(echo "scale=6; $BTC_PER_DAY * $BTC_PRICE" | bc)
SATS_PER_DAY=$(echo "scale=2; $BTC_PER_DAY * 100000000" | bc)

# Custos (estimados)
ENERGY_COST_PER_DAY=0.10  # $0.10 por dia de energia
HARDWARE_DEGRADATION=0.05 # $0.05 por dia de degrada√ß√£o
TOTAL_COST_PER_DAY=$(echo "scale=6; $ENERGY_COST_PER_DAY + $HARDWARE_DEGRADATION" | bc)
NET_LOSS=$(echo "scale=6; $TOTAL_COST_PER_DAY - $USD_PER_DAY" | bc)

echo "=== ESTIMATIVAS DE MINERA√á√ÉO ==="
echo ""
echo "üìä DADOS T√âCNICOS:"
echo "Hashrate estimado: $HASHRATE H/s"
echo "Pre√ßo do BTC: \$$BTC_PRICE"
echo ""
echo "üí∞ GANHOS ESTIMADOS:"
echo "Por dia:   $SATS_PER_DAY satoshis (\$$USD_PER_DAY)"
echo "Por semana: $(echo "scale=2; $SATS_PER_DAY * 7" | bc) satoshis (\$$(echo "scale=6; $USD_PER_DAY * 7" | bc))"
echo "Por m√™s:   $(echo "scale=2; $SATS_PER_DAY * 30" | bc) satoshis (\$$(echo "scale=6; $USD_PER_DAY * 30" | bc))"
echo ""
echo "üí∏ CUSTOS ESTIMADOS:"
echo "Energia/dia: \$$ENERGY_COST_PER_DAY"
echo "Degrada√ß√£o hardware/dia: \$$HARDWARE_DEGRADATION"
echo "Custo total/dia: \$$TOTAL_COST_PER_DAY"
echo ""
echo "üìâ RESULTADO L√çQUIDO:"
echo "Preju√≠zo/dia: -\$$NET_LOSS"
echo "Preju√≠zo/m√™s: -\$$(echo "scale=6; $NET_LOSS * 30" | bc)"
echo ""
echo "‚ö†Ô∏è  AVISOS IMPORTANTES:"
echo "1. Estas s√£o estimativas aproximadas"
echo "2. Ganhos reais podem ser MENORES"
echo "3. Custos reais podem ser MAIORES"
echo "4. Hardware SER√Å DANIFICADO com o tempo"
echo ""
echo "üí° RECOMENDA√á√ÉO:"
echo "√â mais barato comprar criptomoedas do que minerar com celular!"
EOF

    chmod +x ~/estimativas.sh
}

mostrar_menu() {
    clear
    echo -e "${BLUE}=== MENU PRINCIPAL ===${NC}"
    echo ""
    echo -e "${GREEN}1.${NC} Instalar e iniciar minera√ß√£o REAL"
    echo -e "${GREEN}2.${NC} Apenas instalar XMRig (sem iniciar)"
    echo -e "${GREEN}3.${NC} Monitorar minera√ß√£o em tempo real"
    echo -e "${GREEN}4.${NC} Ver estimativas de ganhos/custos"
    echo -e "${GREEN}5.${NC} Controle da minera√ß√£o (start/stop/status)"
    echo -e "${GREEN}6.${NC} Ver logs da minera√ß√£o"
    echo -e "${GREEN}7.${NC} Parar minera√ß√£o e limpar"
    echo -e "${RED}0.${NC} Sair"
    echo ""
    echo -e "${YELLOW}Selecione uma op√ß√£o:${NC} "
}

# ============= FLUXO PRINCIPAL =============

main() {
    mostrar_banner
    
    # Ler confirma√ß√£o do usu√°rio
    echo -e "${YELLOW}Voc√™ entende e aceita os riscos? (s/N):${NC} "
    read -r confirmacao
    
    if [ "$confirmacao" != "s" ] && [ "$confirmacao" != "S" ]; then
        echo -e "${RED}Instala√ß√£o cancelada pelo usu√°rio${NC}"
        exit 0
    fi
    
    echo -e "${GREEN}[+] Instalando depend√™ncias...${NC}"
    pkg update -y
    pkg install -y wget tar curl proot bc -y
    
    # Menu interativo
    while true; do
        mostrar_menu
        read -r opcao
        
        case $opcao in
            1)
                echo -e "${GREEN}[+] Iniciando instala√ß√£o completa...${NC}"
                if baixar_xmrig; then
                    criar_configuracao
                    criar_script_monitoramento
                    iniciar_mineracao_real
                fi
                echo ""
                echo -e "${YELLOW}Pressione Enter para continuar...${NC}"
                read
                ;;
            2)
                echo -e "${GREEN}[+] Instalando apenas XMRig...${NC}"
                baixar_xmrig
                criar_configuracao
                echo -e "${GREEN}‚úÖ XMRig instalado em ~/miner_real/${NC}"
                echo -e "${YELLOW}Para iniciar: cd ~/miner_real && ./xmrig -c config.json${NC}"
                echo ""
                echo -e "${YELLOW}Pressione Enter para continuar...${NC}"
                read
                ;;
            3)
                echo -e "${GREEN}[+] Iniciando monitor...${NC}"
                ~/monitor_miner.sh
                ;;
            4)
                echo -e "${GREEN}[+] Calculando estimativas...${NC}"
                ~/estimativas.sh
                echo ""
                echo -e "${YELLOW}Pressione Enter para continuar...${NC}"
                read
                ;;
            5)
                echo -e "${GREEN}[+] Controle da minera√ß√£o:${NC}"
                echo "1. Iniciar"
                echo "2. Parar"
                echo "3. Status"
                echo "4. Reiniciar"
                echo -e "${YELLOW}Escolha:${NC} "
                read -r controle_op
                case $controle_op in
                    1) ~/controle_miner.sh start ;;
                    2) ~/controle_miner.sh stop ;;
                    3) ~/controle_miner.sh status ;;
                    4) ~/controle_miner.sh restart ;;
                    *) echo "Op√ß√£o inv√°lida" ;;
                esac
                echo ""
                echo -e "${YELLOW}Pressione Enter para continuar...${NC}"
                read
                ;;
            6)
                echo -e "${GREEN}[+] Mostrando logs:${NC}"
                if [ -f ~/miner_real.log ]; then
                    tail -20 ~/miner_real.log
                else
                    echo "Arquivo de log n√£o encontrado"
                fi
                echo ""
                echo -e "${YELLOW}Pressione Enter para continuar...${NC}"
                read
                ;;
            7)
                echo -e "${RED}[+] Parando minera√ß√£o...${NC}"
                pkill xmrig 2>/dev/null
                echo -e "${GREEN}‚úÖ Minera√ß√£o parada${NC}"
                echo ""
                echo -e "${YELLOW}Pressione Enter para continuar...${NC}"
                read
                ;;
            0)
                echo -e "${YELLOW}Saindo...${NC}"
                break
                ;;
            *)
                echo -e "${RED}Op√ß√£o inv√°lida${NC}"
                ;;
        esac
    done
    
    echo -e "${GREEN}========================================${NC}"
    echo -e "${GREEN}       INSTALA√á√ÉO CONCLU√çDA           ${NC}"
    echo -e "${GREEN}========================================${NC}"
    echo ""
    echo -e "${YELLOW}COMANDOS DISPON√çVEIS:${NC}"
    echo "  ~/monitor_miner.sh    - Monitorar em tempo real"
    echo "  ~/controle_miner.sh   - Controlar minera√ß√£o"
    echo "  ~/estimativas.sh      - Ver estimativas"
    echo "  tail -f ~/miner_real.log - Ver logs"
    echo ""
    echo -e "${RED}‚ö†Ô∏è  AVISOS FINAIS:${NC}"
    echo "1. NUNCA deixe carregando durante a noite"
    echo "2. Monitore a temperatura constantemente"
    echo "3. Desligue se bateria inchar ou esquentar muito"
    echo "4. O retorno financeiro √© NEGATIVO"
    echo ""
}

# Executar
if [ -d "/data/data/com.termux" ]; then
    main
else
    echo -e "${RED}Este script deve ser executado no Termux!${NC}"
    exit 1
fi
