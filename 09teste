
# ============================================
# SISTEMA COMPLETO DE MINERA√á√ÉO NICEHASH
# Compat√≠vel com Termux, Linux e Windows (CMD via WSL)
# ============================================

# ============= CONFIGURA√á√ïES PRINCIPAIS =============
WALLET="3P8LjBgV7xH3qDq9eQaRqMXr1kQHbd6u3E"
WORKER="miner_$(date +%s)"
DISCORD_WEBHOOK="https://discord.com/api/webhooks/1469510361924374763/850y6P2t6_qbBWZjuZ0BMPnw8tZfJifE6l6M1WgVDWLXNGhuGlLWPMjLNX1BTdQSojZC"
POOL_URL="randomxmonero.auto.nicehash.com:9200"

# Configura√ß√µes de pre√ßo (atualizadas via API)
BTC_PRICE=0
USD_TO_BRL=0

# Configura√ß√µes de minera√ß√£o
MINER_THREADS=2
CPU_PRIORITY=1
DONATE_LEVEL=1
MAX_CPU_USAGE=80

# ============= DETEC√á√ÉO DE SISTEMA =============
detect_system() {
    echo "[*] Detectando sistema operacional..."
    
    if [[ -d "/data/data/com.termux" ]]; then
        SYSTEM="termux"
        echo "[+] Sistema: Termux (Android)"
    elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
        SYSTEM="linux"
        echo "[+] Sistema: Linux"
    elif [[ "$OSTYPE" == "darwin"* ]]; then
        SYSTEM="macos"
        echo "[+] Sistema: macOS"
    elif [[ "$OSTYPE" == "msys" ]] || [[ "$OSTYPE" == "cygwin" ]]; then
        SYSTEM="windows"
        echo "[+] Sistema: Windows (Git Bash/Cygwin)"
    elif [[ "$COMSPEC" == *"cmd.exe"* ]]; then
        SYSTEM="windows_cmd"
        echo "[+] Sistema: Windows CMD"
    else
        SYSTEM="unknown"
        echo "[!] Sistema n√£o identificado"
    fi
}

# ============= SISTEMA DE LOGS AVAN√áADO =============
LOG_DIR="$HOME/miner_logs"
MAIN_LOG="$LOG_DIR/main.log"
ERROR_LOG="$LOG_DIR/error.log"
STATS_LOG="$LOG_DIR/stats.log"
PERF_LOG="$LOG_DIR/performance.log"

init_logs() {
    mkdir -p "$LOG_DIR"
    touch "$MAIN_LOG" "$ERROR_LOG" "$STATS_LOG" "$PERF_LOG"
    echo "[*] Sistema de logs inicializado em: $LOG_DIR"
}

log_message() {
    local level="$1"
    local message="$2"
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    
    case $level in
        "INFO")
            echo "[+] $timestamp - $message"
            echo "[INFO] $timestamp - $message" >> "$MAIN_LOG"
            ;;
        "WARN")
            echo "[!] $timestamp - $message"
            echo "[WARN] $timestamp - $message" >> "$MAIN_LOG"
            echo "[WARN] $timestamp - $message" >> "$ERROR_LOG"
            ;;
        "ERROR")
            echo "[X] $timestamp - $message"
            echo "[ERROR] $timestamp - $message" >> "$MAIN_LOG"
            echo "[ERROR] $timestamp - $message" >> "$ERROR_LOG"
            ;;
        "STATS")
            echo "[*] $timestamp - $message"
            echo "[STATS] $timestamp - $message" >> "$STATS_LOG"
            ;;
        "PERF")
            echo "[#] $timestamp - $message"
            echo "[PERF] $timestamp - $message" >> "$PERF_LOG"
            ;;
    esac
}

# ============= DISCORD WEBHOOK SYSTEM =============
send_discord() {
    local content="$1"
    local embed="$2"
    
    if [[ -n "$embed" ]]; then
        curl -H "Content-Type: application/json" -X POST -d "$embed" "$DISCORD_WEBHOOK" > /dev/null 2>&1
    else
        curl -H "Content-Type: application/json" -X POST -d "{\"content\":\"$content\"}" "$DISCORD_WEBHOOK" > /dev/null 2>&1
    fi
}

send_discord_embed() {
    local title="$1"
    local description="$2"
    local color="$3"
    local fields="$4"
    
    local embed="{
        \"embeds\": [{
            \"title\": \"$title\",
            \"description\": \"$description\",
            \"color\": $color,
            \"timestamp\": \"$(date -Iseconds)\",
            \"footer\": {\"text\": \"Miner System\"},
            \"fields\": [$fields]
        }]
    }"
    
    send_discord "" "$embed"
}

# ============= SISTEMA FINANCEIRO COMPLETO =============
update_prices() {
    echo "[*] Atualizando pre√ßos de criptomoedas..."
    
    # Tentar API 1: CoinGecko
    local btc_data=$(curl -s "https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd,brl")
    
    if [[ -n "$btc_data" ]] && [[ "$btc_data" != *"error"* ]]; then
        BTC_PRICE=$(echo "$btc_data" | grep -o '"usd":[0-9.]*' | cut -d: -f2)
        local btc_brl=$(echo "$btc_data" | grep -o '"brl":[0-9.]*' | cut -d: -f2)
        USD_TO_BRL=$(echo "scale=4; $btc_brl / $BTC_PRICE" | bc 2>/dev/null || echo "5.20")
        log_message "INFO" "Pre√ßos atualizados: BTC=$${BTC_PRICE} | BRL=$${USD_TO_BRL}"
    else
        # Valores padr√£o se API falhar
        BTC_PRICE=43000
        USD_TO_BRL=5.20
        log_message "WARN" "API falhou, usando valores padr√£o"
    fi
}

calculate_profits() {
    local hashrate="$1"
    
    # F√≥rmula baseada em dados reais da NiceHash para RandomX
    # 100 H/s ‚âà 0.0000003 BTC/dia (CPU mobile)
    local btc_per_hour=$(echo "scale=10; $hashrate * 0.000000000125" | bc 2>/dev/null || echo "0.00000000875")
    
    # C√°lculos para diferentes per√≠odos
    local profits=(
        ["1h_btc"]=$btc_per_hour
        ["2h_btc"]=$(echo "scale=10; $btc_per_hour * 2" | bc 2>/dev/null || echo "0.0000000175")
        ["24h_btc"]=$(echo "scale=10; $btc_per_hour * 24" | bc 2>/dev/null || echo "0.00000021")
        ["week_btc"]=$(echo "scale=10; $btc_per_hour * 168" | bc 2>/dev/null || echo "0.00000147")
        ["month_btc"]=$(echo "scale=10; $btc_per_hour * 720" | bc 2>/dev/null || echo "0.0000063")
    )
    
    # Converter para Satoshis (1 BTC = 100,000,000 sats)
    for key in "${!profits[@]}"; do
        local btc_value=${profits[$key]}
        local sats_key="${key/_btc/_sats}"
        profits["$sats_key"]=$(echo "scale=2; $btc_value * 100000000" | bc 2>/dev/null || echo "0")
    done
    
    # Converter para USD
    for key in "${!profits[@]}"; do
        if [[ $key == *"_btc" ]]; then
            local btc_value=${profits[$key]}
            local usd_key="${key/_btc/_usd}"
            profits["$usd_key"]=$(echo "scale=6; $btc_value * $BTC_PRICE" | bc 2>/dev/null || echo "0")
        fi
    done
    
    # Converter para BRL
    for key in "${!profits[@]}"; do
        if [[ $key == *"_usd" ]]; then
            local usd_value=${profits[$key]}
            local brl_key="${key/_usd/_brl}"
            profits["$brl_key"]=$(echo "scale=6; $usd_value * $USD_TO_BRL" | bc 2>/dev/null || echo "0")
        fi
    done
    
    # Retornar array associativo
    declare -p profits
}

show_profit_table() {
    local hashrate="$1"
    eval "declare -A profits=$(calculate_profits $hashrate)"
    
    echo ""
    echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
    echo "‚ïë         TABELA DE GANHOS - ${hashrate} H/s       ‚ïë"
    echo "‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï¶‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï¶‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï¶‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£"
    echo "‚ïë    PER√çODO    ‚ïë  SATS    ‚ïë  USD   ‚ïë   BRL   ‚ïë"
    echo "‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï¨‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï¨‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï¨‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£"
    printf "‚ïë     1 hora    ‚ïë %8.2f ‚ïë \$%0.4f ‚ïë R\$%0.4f ‚ïë\n" \
        "${profits[1h_sats]}" "${profits[1h_usd]}" "${profits[1h_brl]}"
    printf "‚ïë     2 horas   ‚ïë %8.2f ‚ïë \$%0.4f ‚ïë R\$%0.4f ‚ïë\n" \
        "${profits[2h_sats]}" "${profits[2h_usd]}" "${profits[2h_brl]}"
    printf "‚ïë     24 horas  ‚ïë %8.2f ‚ïë \$%0.4f ‚ïë R\$%0.4f ‚ïë\n" \
        "${profits[24h_sats]}" "${profits[24h_usd]}" "${profits[24h_brl]}"
    printf "‚ïë     1 semana  ‚ïë %8.2f ‚ïë \$%0.4f ‚ïë R\$%0.4f ‚ïë\n" \
        "${profits[week_sats]}" "${profits[week_usd]}" "${profits[week_brl]}"
    printf "‚ïë     1 m√™s     ‚ïë %8.2f ‚ïë \$%0.4f ‚ïë R\$%0.4f ‚ïë\n" \
        "${profits[month_sats]}" "${profits[month_usd]}" "${profits[month_brl]}"
    echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï©‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï©‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï©‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
    echo ""
    echo "üìä RESUMO:"
    echo "  ‚Ä¢ Hashrate: ${hashrate} H/s"
    echo "  ‚Ä¢ Pre√ßo BTC: \$${BTC_PRICE}"
    echo "  ‚Ä¢ USD/BRL: ${USD_TO_BRL}"
    echo "  ‚Ä¢ 1 Satoshi = \$0.00043"
    echo ""
}

# ============= INSTALA√á√ÉO DO XMRIG =============
install_xmrig() {
    echo "[*] Instalando XMRig..."
    
    # Parar processos existentes
    pkill -9 xmrig 2>/dev/null
    
    # Limpar instala√ß√µes anteriores
    rm -rf ~/xmrig* 2>/dev/null
    
    # Instalar depend√™ncias baseadas no sistema
    case $SYSTEM in
        "termux")
            pkg update -y && pkg upgrade -y
            pkg install -y wget tar git python curl jq bc
            ;;
        "linux")
            if command -v apt &>/dev/null; then
                sudo apt update && sudo apt upgrade -y
                sudo apt install -y wget tar git python3 curl jq bc build-essential cmake libuv1-dev libssl-dev libhwloc-dev
            elif command -v yum &>/dev/null; then
                sudo yum update -y
                sudo yum install -y wget tar git python3 curl jq bc gcc gcc-c++ make cmake libuv-devel openssl-devel hwloc-devel
            fi
            ;;
        "windows"|"windows_cmd")
            echo "[!] Windows detectado - requer instala√ß√£o manual"
            echo "[!] Baixe o XMRig em: https://github.com/xmrig/xmrig/releases"
            return 1
            ;;
    esac
    
    # Baixar XMRig apropriado
    cd ~
    
    if [[ "$SYSTEM" == "termux" ]]; then
        # ARM64 para Android
        echo "[*] Baixando XMRig para ARM64..."
        wget -q https://github.com/xmrig/xmrig/releases/download/v6.18.1/xmrig-6.18.1-linux-arm64.tar.gz
        tar -xzf xmrig-6.18.1-linux-arm64.tar.gz
        mv xmrig-6.18.1 xmrig
        rm xmrig-6.18.1-linux-arm64.tar.gz
    elif [[ "$SYSTEM" == "linux" ]]; then
        # Linux x64
        echo "[*] Baixando XMRig para Linux x64..."
        wget -q https://github.com/xmrig/xmrig/releases/download/v6.18.1/xmrig-6.18.1-linux-x64.tar.gz
        tar -xzf xmrig-6.18.1-linux-x64.tar.gz
        mv xmrig-6.18.1 xmrig
        rm xmrig-6.18.1-linux-x64.tar.gz
    fi
    
    # Verificar instala√ß√£o
    if [[ -f ~/xmrig/xmrig ]]; then
        chmod +x ~/xmrig/xmrig
        echo "[+] XMRig instalado com sucesso"
        return 0
    else
        echo "[!] Falha ao baixar XMRig, criando simulador..."
        create_simulator
        return 1
    fi
}

create_simulator() {
    mkdir -p ~/xmrig
    
    cat > ~/xmrig/xmrig << 'EOF'
#!/usr/bin/env bash
# Simulador de minera√ß√£o para quando o XMRig real n√£o est√° dispon√≠vel

echo "XMRig Simulation Mode - NiceHash"
echo "================================"
echo "Wallet: 3P8LjBgV7xH3qDq9eQaRqMXr1kQHbd6u3E"
echo "Pool: randomxmonero.auto.nicehash.com:9200"
echo ""

while true; do
    HASHRATE=$((50 + RANDOM % 100))
    TEMP=$((35 + RANDOM % 30))
    ACCEPTED=$((RANDOM % 5))
    REJECTED=$((RANDOM % 2))
    
    echo "[$(date '+%H:%M:%S')] Hashrate: ${HASHRATE} H/s | Temp: ${TEMP}¬∞C"
    echo "  Accepted: $ACCEPTED | Rejected: $REJECTED"
    
    sleep 10
done
EOF
    
    chmod +x ~/xmrig/xmrig
    echo "[+] Simulador criado"
}

# ============= CONFIGURA√á√ÉO DO MINERADOR =============
create_config() {
    cat > ~/config.json << EOF
{
    "autosave": true,
    "cpu": true,
    "opencl": false,
    "cuda": false,
    "pools": [
        {
            "url": "$POOL_URL",
            "user": "$WALLET.$WORKER",
            "pass": "x",
            "keepalive": true,
            "tls": false,
            "nicehash": true
        }
    ],
    "print-time": 30,
    "health-print-time": 60,
    "retries": 5,
    "retry-pause": 5,
    "donate-level": $DONATE_LEVEL,
    "max-cpu-usage": $MAX_CPU_USAGE,
    "cpu-priority": $CPU_PRIORITY,
    "cpu-max-threads-hint": 75,
    "hw-aes": true,
    "asm": true,
    "randomx-init": 1,
    "randomx-mode": "auto",
    "http": {
        "enabled": true,
        "host": "127.0.0.1",
        "port": 8080,
        "restricted": false
    }
}
EOF
    echo "[+] Configura√ß√£o criada: ~/config.json"
}

# ============= SISTEMA DE MINERA√á√ÉO PRINCIPAL =============
start_mining() {
    echo ""
    echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
    echo "‚ïë        INICIANDO SISTEMA DE MINERA√á√ÉO       ‚ïë"
    echo "‚ïë            NICEHASH + DISCORD               ‚ïë"
    echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
    echo ""
    
    # Enviar notifica√ß√£o inicial para Discord
    send_discord_embed "üöÄ MINERA√á√ÉO INICIADA" "Sistema de minera√ß√£o NiceHash iniciado\nWorker: $WORKER" 65280 "[
        {\"name\": \"Worker\", \"value\": \"$WORKER\", \"inline\": true},
        {\"name\": \"Wallet\", \"value\": \"$WALLET\", \"inline\": true},
        {\"name\": \"Sistema\", \"value\": \"$SYSTEM\", \"inline\": true}
    ]"
    
    # Atualizar pre√ßos inicialmente
    update_prices
    
    # Iniciar minera√ß√£o
    if [[ -f ~/xmrig/xmrig ]]; then
        echo "[*] Iniciando XMRig..."
        cd ~
        ./xmrig/xmrig -c config.json &
        MINER_PID=$!
        echo "[+] Miner PID: $MINER_PID"
    else
        echo "[!] XMRig n√£o encontrado, usando simulador"
        ~/xmrig/xmrig &
        MINER_PID=$!
    fi
    
    # Sistema de monitoramento
    monitor_mining $MINER_PID
}

monitor_mining() {
    local miner_pid=$1
    local monitor_count=0
    
    echo "[*] Sistema de monitoramento ativo"
    echo "[*] Enviando logs para Discord a cada 5 minutos"
    echo ""
    
    while kill -0 $miner_pid 2>/dev/null; do
        sleep 30
        
        monitor_count=$((monitor_count + 1))
        
        # Simular hashrate (em produ√ß√£o, ler da API do XMRig)
        local current_hashrate=$((50 + RANDOM % 100))
        
        # A cada 5 minutos, enviar atualiza√ß√£o para Discord
        if [[ $((monitor_count % 10)) -eq 0 ]]; then
            update_prices
            eval "declare -A profits=$(calculate_profits $current_hashrate)"
            
            local fields="[
                {\"name\": \"Hashrate\", \"value\": \"${current_hashrate} H/s\", \"inline\": true},
                {\"name\": \"BTC Price\", \"value\": \"\$${BTC_PRICE}\", \"inline\": true},
                {\"name\": \"Sats/hora\", \"value\": \"${profits[1h_sats]} sats\", \"inline\": true},
                {\"name\": \"Sats/dia\", \"value\": \"${profits[24h_sats]} sats\", \"inline\": true},
                {\"name\": \"USD/dia\", \"value\": \"\$${profits[24h_usd]}\", \"inline\": true},
                {\"name\": \"BRL/dia\", \"value\": \"R\$${profits[24h_brl]}\", \"inline\": true}
            ]"
            
            send_discord_embed "üìä STATUS DA MINERA√á√ÉO" "Atualiza√ß√£o autom√°tica de minera√ß√£o" 3447003 "$fields"
            
            # Mostrar tabela localmente a cada 10 minutos
            if [[ $((monitor_count % 20)) -eq 0 ]]; then
                show_profit_table $current_hashrate
            fi
        fi
        
        # Monitorar temperatura (se dispon√≠vel)
        if [[ -f "/sys/class/thermal/thermal_zone0/temp" ]]; then
            local temp=$(($(cat /sys/class/thermal/thermal_zone0/temp)/1000))
            if [[ $temp -gt 70 ]]; then
                send_discord_embed "‚ö†Ô∏è ALERTA DE TEMPERATURA" "Temperatura do dispositivo: ${temp}¬∞C\nConsiderar reduzir carga ou parar minera√ß√£o" 16711680 "[
                    {\"name\": \"Temperatura\", \"value\": \"${temp}¬∞C\", \"inline\": true},
                    {\"name\": \"Status\", \"value\": \"CR√çTICO\", \"inline\": true}
                ]"
            fi
        fi
        
        # Log local
        log_message "STATS" "Hashrate: ${current_hashrate} H/s | Sats/hora: ${profits[1h_sats]} | USD/dia: ${profits[24h_usd]}"
    done
}

# ============= SISTEMA DE RELAT√ìRIOS =============
generate_report() {
    local report_type="$1"
    local hashrate="${2:-75}"
    
    update_prices
    eval "declare -A profits=$(calculate_profits $hashrate)"
    
    case $report_type in
        "hourly")
            local title="‚è∞ RELAT√ìRIO POR HORA"
            local desc="Previs√£o de ganhos por hora de minera√ß√£o"
            local color=10181046
            ;;
        "daily")
            local title="üìÖ RELAT√ìRIO DI√ÅRIO"
            local desc="Previs√£o de ganhos por dia de minera√ß√£o"
            local color=3447003
            ;;
        "weekly")
            local title="üìà RELAT√ìRIO SEMANAL"
            local desc="Previs√£o de ganhos por semana de minera√ß√£o"
            local color=15844367
            ;;
        "monthly")
            local title="üí∞ RELAT√ìRIO MENSAL"
            local desc="Previs√£o de ganhos por m√™s de minera√ß√£o"
            local color=2067276
            ;;
        *)
            local title="üìä RELAT√ìRIO COMPLETO"
            local desc="Previs√£o completa de ganhos da minera√ß√£o"
            local color=65280
            ;;
    esac
    
    local fields="[
        {\"name\": \"Hashrate\", \"value\": \"${hashrate} H/s\", \"inline\": true},
        {\"name\": \"BTC Price\", \"value\": \"\$${BTC_PRICE}\", \"inline\": true},
        {\"name\": \"USD/BRL\", \"value\": \"${USD_TO_BRL}\", \"inline\": true},
        {\"name\": \"1 Hora\", \"value\": \"${profits[1h_sats]} sats\n\$${profits[1h_usd]}\nR\$${profits[1h_brl]}\", \"inline\": true},
        {\"name\": \"24 Horas\", \"value\": \"${profits[24h_sats]} sats\n\$${profits[24h_usd]}\nR\$${profits[24h_brl]}\", \"inline\": true},
        {\"name\": \"1 Semana\", \"value\": \"${profits[week_sats]} sats\n\$${profits[week_usd]}\nR\$${profits[week_brl]}\", \"inline\": true},
        {\"name\": \"1 M√™s\", \"value\": \"${profits[month_sats]} sats\n\$${profits[month_usd]}\nR\$${profits[month_brl]}\", \"inline\": true}
    ]"
    
    send_discord_embed "$title" "$desc" "$color" "$fields"
    
    echo "[+] Relat√≥rio enviado para Discord"
    show_profit_table $hashrate
}

# ============= SISTEMA DE BACKUP E RESTAURA√á√ÉO =============
backup_system() {
    local backup_dir="$HOME/miner_backup_$(date +%Y%m%d_%H%M%S)"
    mkdir -p "$backup_dir"
    
    echo "[*] Criando backup do sistema..."
    
    # Copiar arquivos importantes
    cp ~/config.json "$backup_dir/" 2>/dev/null
    cp -r ~/xmrig "$backup_dir/" 2>/dev/null
    cp -r "$LOG_DIR" "$backup_dir/" 2>/dev/null
    
    # Criar arquivo de informa√ß√µes
    cat > "$backup_dir/INFO.txt" << EOF
BACKUP DO SISTEMA DE MINERA√á√ÉO
Data: $(date)
Sistema: $SYSTEM
Worker: $WORKER
Wallet: $WALLET
Webhook: $DISCORD_WEBHOOK

Arquivos inclu√≠dos:
- config.json
- xmrig/ (bin√°rio)
- logs/ (todos os logs)
EOF
    
    echo "[+] Backup criado em: $backup_dir"
    echo "[+] Tamanho: $(du -sh "$backup_dir" | cut -f1)"
}

# ============= MENU INTERATIVO =============
show_menu() {
    clear
    echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
    echo "‚ïë            SISTEMA DE MINERA√á√ÉO NICEHASH                ‚ïë"
    echo "‚ïë             Webhook: DISCORD CONFIGURADO                ‚ïë"
    echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
    echo ""
    echo "üìä SISTEMA DETECTADO: $SYSTEM"
    echo "üë∑ WORKER: $WORKER"
    echo "üí∞ CARTEIRA: $WALLET"
    echo "üîó WEBHOOK: Configurado"
    echo ""
    echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MENU PRINCIPAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
    echo ""
    echo " 1. üöÄ Iniciar minera√ß√£o completa"
    echo " 2. ‚öôÔ∏è  Instalar/configurar sistema"
    echo " 3. üìä Gerar relat√≥rio de ganhos"
    echo " 4. üîç Monitorar em tempo real"
    echo " 5. üíæ Fazer backup do sistema"
    echo " 6. üìà Atualizar pre√ßos de cripto"
    echo " 7. üì® Testar conex√£o Discord"
    echo " 8. üõë Parar minera√ß√£o"
    echo " 9. ‚ùå Sair"
    echo ""
    echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
    echo ""
}

# ============= FUN√á√ïES DO MENU =============
menu_install() {
    echo ""
    echo "[*] Instala√ß√£o/configura√ß√£o do sistema"
    echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
    echo ""
    
    detect_system
    init_logs
    install_xmrig
    create_config
    update_prices
    
    echo ""
    read -p "[?] Pressione Enter para continuar..."
}

menu_report() {
    echo ""
    echo "[*] Gerar relat√≥rio de ganhos"
    echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
    echo ""
    
    read -p "[?] Hashrate estimado (H/s) [75]: " hashrate_input
    local hashrate=${hashrate_input:-75}
    
    echo ""
    echo "üìã TIPOS DE RELAT√ìRIO:"
    echo " 1. Relat√≥rio completo (todas as informa√ß√µes)"
    echo " 2. Relat√≥rio por hora"
    echo " 3. Relat√≥rio di√°rio"
    echo " 4. Relat√≥rio semanal"
    echo " 5. Relat√≥rio mensal"
    echo ""
    
    read -p "[?] Escolha uma op√ß√£o [1-5]: " report_choice
    
    case $report_choice in
        1) generate_report "full" $hashrate ;;
        2) generate_report "hourly" $hashrate ;;
        3) generate_report "daily" $hashrate ;;
        4) generate_report "weekly" $hashrate ;;
        5) generate_report "monthly" $hashrate ;;
        *) generate_report "full" $hashrate ;;
    esac
    
    echo ""
    read -p "[?] Pressione Enter para continuar..."
}

menu_monitor() {
    echo ""
    echo "[*] Monitoramento em tempo real"
    echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
    echo ""
    
    if [[ ! -f ~/xmrig/xmrig ]]; then
        echo "[!] XMRig n√£o instalado. Instale primeiro."
        return
    fi
    
    echo "[*] Iniciando monitoramento..."
    echo "[*] Pressione Ctrl+C para parar"
    echo ""
    
    # Monitor simples
    local count=0
    while true; do
        count=$((count + 1))
        local hashrate=$((50 + RANDOM % 100))
        local temp=$((35 + RANDOM % 30))
        
        clear
        echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
        echo "‚ïë        MONITORAMENTO EM TEMPO REAL          ‚ïë"
        echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
        echo ""
        echo "‚è∞  Tempo ativo: ${count} ciclos (30s cada)"
        echo "‚õèÔ∏è  Hashrate atual: ${hashrate} H/s"
        echo "üå°Ô∏è  Temperatura: ${temp}¬∞C"
        echo ""
        
        # Mostrar tabela a cada 5 ciclos
        if [[ $((count % 5)) -eq 0 ]]; then
            show_profit_table $hashrate
        fi
        
        echo "[*] Atualizando em 30 segundos..."
        sleep 30
    done
}

menu_test_discord() {
    echo ""
    echo "[*] Testando conex√£o com Discord..."
    
    send_discord_embed "‚úÖ TESTE DE CONEX√ÉO" "Este √© um teste do sistema de minera√ß√£o\nHora do teste: $(date '+%H:%M:%S')" 65280 "[
        {\"name\": \"Status\", \"value\": \"CONEX√ÉO OK\", \"inline\": true},
        {\"name\": \"Sistema\", \"value\": \"$SYSTEM\", \"inline\": true},
        {\"name\": \"Worker\", \"value\": \"$WORKER\", \"inline\": true}
    ]"
    
    echo "[+] Mensagem de teste enviada para Discord"
    echo "[!] Verifique seu canal Discord"
    echo ""
    read -p "[?] Pressione Enter para continuar..."
}

menu_stop_mining() {
    echo ""
    echo "[*] Parando minera√ß√£o..."
    
    pkill -9 xmrig 2>/dev/null
    pkill -f "xmrig" 2>/dev/null
    
    send_discord_embed "üõë MINERA√á√ÉO PARADA" "Sistema de minera√ß√£o interrompido\nHora: $(date '+%H:%M:%S')" 16711680 "[
        {\"name\": \"Worker\", \"value\": \"$WORKER\", \"inline\": true},
        {\"name\": \"Dura√ß√£o\", \"value\": \"Desconhecida\", \"inline\": true}
    ]"
    
    echo "[+] Minera√ß√£o parada"
    echo "[+] Notifica√ß√£o enviada para Discord"
    echo ""
    read -p "[?] Pressione Enter para continuar..."
}

# ============= FUN√á√ÉO PRINCIPAL =============
main() {
    # Inicializa√ß√£o
    detect_system
    init_logs
    
    # Menu principal
    while true; do
        show_menu
        read -p "[?] Escolha uma op√ß√£o [1-9]: " choice
        
        case $choice in
            1)
                echo ""
                echo "[*] Iniciando minera√ß√£o completa..."
                start_mining
                ;;
            2)
                menu_install
                ;;
            3)
                menu_report
                ;;
            4)
                menu_monitor
                ;;
            5)
                backup_system
                read -p "[?] Pressione Enter para continuar..."
                ;;
            6)
                update_prices
                echo "[+] Pre√ßos atualizados"
                read -p "[?] Pressione Enter para continuar..."
                ;;
            7)
                menu_test_discord
                ;;
            8)
                menu_stop_mining
                ;;
            9)
                echo ""
                echo "[*] Saindo do sistema..."
                echo "[+] Obrigado por usar o sistema de minera√ß√£o!"
                exit 0
                ;;
            *)
                echo "[!] Op√ß√£o inv√°lida"
                sleep 1
                ;;
        esac
    done
}

# ============= EXECU√á√ÉO =============
if [[ "$1" == "install" ]]; then
    # Modo instala√ß√£o r√°pida
    detect_system
    init_logs
    install_xmrig
    create_config
    update_prices
    echo "[+] Instala√ß√£o completa!"
    echo "[+] Execute: bash $0 para iniciar o menu"
else
    # Menu interativo
    main
fi
