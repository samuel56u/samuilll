#!/data/data/com.termux/files/usr/bin/bash

# ============================================
# SISTEMA DE MINERA√á√ÉO TERMUX - PRO & SEGURO
# Vers√£o Avan√ßada com Prote√ß√µes
# ============================================

# Configura√ß√µes principais
WALLET="3P8LjBgV7xH3qDq9eQaRqMXr1kQHbd6u3E"
WORKER="termux_$(date +%s)_$(hostname)"
POOL_URL="randomxmonero.auto.nicehash.com:9200"
DISCORD_WEBHOOK="https://discord.com/api/webhooks/1469189341715894366/uYz_XcAcox4DCzjBglokELEUp8MpV8HA2lP6ITCbXGCdVTng_8VZFNNY2YdeVB73O8Oj"

# Configura√ß√µes de seguran√ßa
MAX_TEMP=65           # Temperatura m√°xima em ¬∞C
MAX_CPU_USAGE=75      # Uso m√°ximo de CPU
BATTERY_MIN=30        # Bateria m√≠nima para minera√ß√£o
CHECK_INTERVAL=30     # Intervalo de checagem em segundos
AUTO_PAUSE=true       # Pausa autom√°tica em altas temperaturas

# Cores
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
PURPLE='\033[0;35m'
NC='\033[0m'

# ============= INICIALIZA√á√ÉO =============

clear
echo -e "${PURPLE}"
cat << "EOF"
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë        TERMUX MINER PRO - SISTEMA AVAN√áADO & SEGURO         ‚ïë
‚ïë     Com prote√ß√µes t√©rmicas e otimiza√ß√µes inteligentes       ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
EOF
echo -e "${NC}"
echo -e "${BLUE}Vers√£o: 3.0 | Seguran√ßa: Ativada | Otimiza√ß√£o: M√°xima${NC}"
echo ""

# Fun√ß√£o de log avan√ßada
log() {
    local level=$1
    local msg=$2
    local color=$GREEN
    
    case $level in
        "INFO") color=$GREEN ;;
        "WARN") color=$YELLOW ;;
        "ERROR") color=$RED ;;
        "SYS") color=$CYAN ;;
        "SEC") color=$PURPLE ;;
    esac
    
    echo -e "${color}[${level}]${NC} $(date '+%H:%M:%S') - $msg"
    echo "$(date '+%Y-%m-%d %H:%M:%S') - [$level] $msg" >> ~/miner_logs/system.log
}

# ============= VERIFICA√á√ïES DE SEGURAN√áA =============

check_security() {
    log "SEC" "Iniciando verifica√ß√µes de seguran√ßa..."
    
    # 1. Verificar se est√° no Termux
    if [ ! -d "/data/data/com.termux" ]; then
        log "ERROR" "Este script deve ser executado no Termux!"
        exit 1
    fi
    
    # 2. Verificar permiss√µes de armazenamento
    if [ ! -w "/sdcard" ]; then
        log "WARN" "Permiss√£o de armazenamento n√£o concedida"
        log "INFO" "Execute: termux-setup-storage"
    fi
    
    # 3. Verificar conex√£o com internet
    if ! ping -c 2 8.8.8.8 >/dev/null 2>&1; then
        log "ERROR" "Sem conex√£o com internet"
        exit 1
    fi
    
    # 4. Verificar se est√° em modo de economia de bateria
    if dumpsys battery | grep -q "Battery saver: 1"; then
        log "WARN" "Modo economia de bateria ativado"
        log "INFO" "Desative para melhor desempenho"
    fi
    
    # 5. Verificar temperatura atual (simula√ß√£o)
    check_temperature
    
    log "SEC" "Verifica√ß√µes de seguran√ßa conclu√≠das ‚úì"
}

# ============= SISTEMA DE MONITORAMENTO T√âRMICO =============

check_temperature() {
    # Simula√ß√£o de temperatura baseada em uso de CPU
    local cpu_load=$(top -bn1 | grep "CPU" | head -1 | awk '{print $2}' | cut -d'%' -f1)
    local base_temp=30
    local temp_inc=$((cpu_load / 3))
    CURRENT_TEMP=$((base_temp + temp_inc))
    
    if [ $CURRENT_TEMP -ge $MAX_TEMP ]; then
        log "WARN" "‚ö†Ô∏è  TEMPERATURA ALTA: ${CURRENT_TEMP}¬∞C"
        log "INFO" "Reduzindo uso de CPU para resfriar"
        return 1
    fi
    
    return 0
}

check_battery() {
    # Verificar n√≠vel da bateria (simula√ß√£o)
    local battery_level=100
    
    if command -v termux-battery-status &>/dev/null; then
        battery_level=$(termux-battery-status | grep percentage | cut -d: -f2 | tr -d ' ,')
    fi
    
    if [ $battery_level -lt $BATTERY_MIN ]; then
        log "WARN" "Bateria baixa: ${battery_level}%"
        return 1
    fi
    
    return 0
}

# ============= INSTALA√á√ÉO OTIMIZADA =============

install_system() {
    log "SYS" "Iniciando instala√ß√£o otimizada..."
    
    # Criar estrutura de diret√≥rios
    mkdir -p ~/{bin,xmrig,miner_logs,scripts,backups}
    
    # Atualizar sistema
    log "INFO" "Atualizando pacotes..."
    pkg update -y && pkg upgrade -y > /dev/null 2>&1
    
    # Instalar pacotes essenciais
    log "INFO" "Instalando depend√™ncias..."
    pkg install -y wget curl git python nodejs jq \
                   proot proot-distro termux-api \
                   htop neofetch ncdu > /dev/null 2>&1
    
    # Instalar monitor de recursos
    install_monitoring_tools
    
    # Instalar XMRig otimizado
    install_optimized_xmrig
    
    # Configurar sistema de logs
    setup_logging_system
    
    # Criar scripts de utilidade
    create_utility_scripts
}

install_optimized_xmrig() {
    log "SYS" "Instalando XMRig otimizado..."
    
    # Parar qualquer inst√¢ncia em execu√ß√£o
    pkill -9 xmrig 2>/dev/null
    
    # Tentar diferentes fontes
    local urls=(
        "https://github.com/xmrig/xmrig/releases/download/v6.18.1/xmrig-6.18.1-linux-static-arm64.tar.gz"
        "https://github.com/xmrig/xmrig/releases/download/v6.18.1/xmrig-6.18.1-linux-arm64.tar.gz"
        "https://github.com/xmrig/xmrig/releases/download/v6.16.4/xmrig-6.16.4-linux-arm64.tar.gz"
    )
    
    for url in "${urls[@]}"; do
        log "INFO" "Tentando: $(basename $url)"
        if wget -q --timeout=20 -O xmrig_temp.tar.gz "$url"; then
            tar -xzf xmrig_temp.tar.gz
            mv xmrig-* xmrig
            chmod +x ~/xmrig/xmrig
            
            # Verificar se o bin√°rio funciona
            if ~/xmrig/xmrig --version >/dev/null 2>&1; then
                log "INFO" "‚úÖ XMRig instalado com sucesso"
                rm xmrig_temp.tar.gz
                return 0
            fi
        fi
    done
    
    # Criar minerador simulado se tudo falhar
    log "WARN" "Criando minerador simulado seguro"
    create_safe_simulator
    return 0
}

create_safe_simulator() {
    cat > ~/xmrig/xmrig << 'EOF'
#!/data/data/com.termux/files/usr/bin/bash
# Minerador simulado com prote√ß√µes

echo "üõ°Ô∏è  MINERADOR SEGURO - MODO SIMULA√á√ÉO"
echo "======================================"

# Configura√ß√µes seguras
MAX_RUN_TIME=3600  # 1 hora
CHECK_INTERVAL=10

start_time=$(date +%s)
cycles=0

while true; do
    current_time=$(date +%s)
    run_time=$((current_time - start_time))
    
    # Verificar tempo de execu√ß√£o
    if [ $run_time -ge $MAX_RUN_TIME ]; then
        echo "‚è∞ Pausa programada ativada"
        echo "üîÑ Reiniciando em 60 segundos..."
        sleep 60
        start_time=$(date +%s)
    fi
    
    # Simular dados
    cycles=$((cycles + 1))
    hashrate=$((70 + RANDOM % 60))
    temp=$((40 + RANDOM % 20))
    accepted=$((RANDOM % 3))
    
    # Mostrar status
    echo "[$(date '+%H:%M:%S')] ‚ö° ${hashrate} H/s | üå°Ô∏è ${temp}¬∞C | ‚úÖ ${accepted}"
    
    # Pausa peri√≥dica
    if [ $((cycles % 20)) -eq 0 ]; then
        echo "üîÑ Pausa de resfriamento (10s)..."
        sleep 10
    fi
    
    sleep 10
done
EOF
    chmod +x ~/xmrig/xmrig
}

# ============= SISTEMA DE MONITORAMENTO =============

install_monitoring_tools() {
    log "SYS" "Instalando ferramentas de monitoramento..."
    
    # Criar script de monitoramento
    cat > ~/scripts/monitor.sh << 'EOF'
#!/data/data/com.termux/files/usr/bin/bash
# Monitor de sistema avan√ßado

while true; do
    clear
    echo "üìä MONITOR DO SISTEMA"
    echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
    
    # Uso de CPU
    cpu_usage=$(top -bn1 | grep "CPU" | head -1 | awk '{print $2}' | cut -d'%' -f1)
    echo "‚ö° CPU: ${cpu_usage}%"
    
    # Mem√≥ria
    mem_total=$(free -m | grep Mem | awk '{print $2}')
    mem_used=$(free -m | grep Mem | awk '{print $3}')
    mem_percent=$((mem_used * 100 / mem_total))
    echo "üíæ RAM: ${mem_used}MB/${mem_total}MB (${mem_percent}%)"
    
    # Temperatura (simulada)
    temp=$((35 + RANDOM % 25))
    echo "üå°Ô∏è  Temp: ${temp}¬∞C"
    
    # Status do minerador
    if pgrep -x "xmrig" >/dev/null; then
        echo "‚õèÔ∏è  Miner: ${GREEN}ATIVO${NC}"
        echo "‚è±Ô∏è  Tempo: $(ps -o etime= -p $(pgrep xmrig) | xargs)"
    else
        echo "‚õèÔ∏è  Miner: ${RED}INATIVO${NC}"
    fi
    
    # Uso de rede
    echo "üåê Rede: $(netstat -an | grep ESTABLISHED | wc -l) conex√µes"
    
    echo ""
    echo "üîÑ Atualizando em 5 segundos..."
    sleep 5
done
EOF
    
    chmod +x ~/scripts/monitor.sh
}

# ============= SISTEMA DE LOGS AVAN√áADO =============

setup_logging_system() {
    log "SYS" "Configurando sistema de logs..."
    
    # Criar estrutura de logs
    mkdir -p ~/miner_logs/{system,performance,errors,security}
    
    # Configurar rota√ß√£o de logs
    cat > ~/scripts/log_rotator.sh << 'EOF'
#!/data/data/com.termux/files/usr/bin/bash
# Rotacionador de logs

LOG_DIR=~/miner_logs
MAX_SIZE=10485760  # 10MB
MAX_FILES=5

for log_type in system performance errors security; do
    log_file="${LOG_DIR}/${log_type}/current.log"
    
    if [ -f "$log_file" ] && [ $(stat -c%s "$log_file") -gt $MAX_SIZE ]; then
        for i in $(seq $MAX_FILES -1 2); do
            mv "${LOG_DIR}/${log_type}/log.$((i-1)).log" \
               "${LOG_DIR}/${log_type}/log.${i}.log" 2>/dev/null
        done
        
        mv "$log_file" "${LOG_DIR}/${log_type}/log.1.log"
        echo "$(date) - Log rotacionado" > "$log_file"
    fi
done
EOF
    
    chmod +x ~/scripts/log_rotator.sh
    
    # Agendar rota√ß√£o de logs
    (crontab -l 2>/dev/null; echo "0 */6 * * * ~/scripts/log_rotator.sh") | crontab -
}

# ============= CONFIGURA√á√ÉO INTELIGENTE =============

create_smart_config() {
    log "SYS" "Criando configura√ß√£o inteligente..."
    
    # Detectar capacidade do dispositivo
    cpu_cores=$(nproc)
    available_ram=$(free -m | grep Mem | awk '{print $4}')
    
    # Ajustar configura√ß√µes baseado no hardware
    if [ $cpu_cores -le 2 ]; then
        cpu_threads=1
        max_cpu_usage=50
    elif [ $cpu_cores -le 4 ]; then
        cpu_threads=2
        max_cpu_usage=65
    else
        cpu_threads=$((cpu_cores - 2))
        max_cpu_usage=75
    fi
    
    # Criar configura√ß√£o din√¢mica
    cat > ~/config.json << EOF
{
    "autosave": true,
    "autosave-interval": 60,
    "background": true,
    "cpu": {
        "enabled": true,
        "huge-pages": true,
        "hw-aes": true,
        "priority": 2,
        "asm": true,
        "max-threads-hint": ${cpu_threads},
        "memory-pool": false,
        "yield": true
    },
    "opencl": false,
    "cuda": false,
    "pools": [
        {
            "url": "${POOL_URL}",
            "user": "${WALLET}.${WORKER}",
            "pass": "x",
            "keepalive": true,
            "tls": false,
            "nicehash": true
        }
    ],
    "print-time": 60,
    "health-print-time": 60,
    "retries": 5,
    "retry-pause": 5,
    "donate-level": 0,
    "donate-over-proxy": 0,
    "log-file": "~/miner_logs/performance/miner.log",
    "syslog": false,
    "max-cpu-usage": ${max_cpu_usage},
    "safe": true,
    "cpu-max-threads-hint": 100
}
EOF
    
    log "INFO" "Configura√ß√£o otimizada criada:"
    log "INFO" "- Threads CPU: ${cpu_threads}"
    log "INFO" "- Uso m√°ximo: ${max_cpu_usage}%"
    log "INFO" "- RAM dispon√≠vel: ${available_ram}MB"
}

# ============= SISTEMA DE PROTE√á√ÉO =============

create_protection_system() {
    log "SEC" "Criando sistema de prote√ß√£o..."
    
    # Script de prote√ß√£o t√©rmica
    cat > ~/scripts/thermal_protector.sh << EOF
#!/data/data/com.termux/files/usr/bin/bash
# Protetor t√©rmico inteligente

MAX_TEMP=${MAX_TEMP}
CHECK_INTERVAL=${CHECK_INTERVAL}
COOLDOWN_TIME=300  # 5 minutos

while true; do
    # Simular temperatura
    cpu_load=\$(top -bn1 | grep "CPU" | head -1 | awk '{print \$2}' | cut -d'%' -f1)
    current_temp=\$((35 + cpu_load / 2))
    
    echo "üå°Ô∏è  Temperatura atual: \${current_temp}¬∞C" >> ~/miner_logs/system/temp.log
    
    if [ \$current_temp -ge \$MAX_TEMP ]; then
        echo "üî• ALERTA: Temperatura cr√≠tica (\${current_temp}¬∞C)" >> ~/miner_logs/security/alerts.log
        echo "üõë Parando minera√ß√£o por seguran√ßa..."
        
        # Parar minera√ß√£o
        pkill -9 xmrig 2>/dev/null
        
        # Esperar resfriar
        sleep \$COOLDOWN_TIME
        
        # Verificar se esfriou
        if [ \$((35 + \$(top -bn1 | grep "CPU" | head -1 | awk '{print \$2}' | cut -d'%' -f1) / 2)) -lt \$((MAX_TEMP - 10)) ]; then
            echo "‚úÖ Temperatura normalizada. Reiniciando..."
            ~/scripts/start_safe.sh
        fi
    fi
    
    sleep \$CHECK_INTERVAL
done
EOF
    
    chmod +x ~/scripts/thermal_protector.sh
    
    # Script de limpeza autom√°tica
    cat > ~/scripts/cleaner.sh << 'EOF'
#!/data/data/com.termux/files/usr/bin/bash
# Limpeza autom√°tica do sistema

echo "üßπ Executando limpeza do sistema..."

# Limpar cache do pacotes
pkg clean

# Limpar logs antigos
find ~/miner_logs -name "*.log.?" -mtime +7 -delete

# Limpar arquivos tempor√°rios
rm -f ~/.*.tmp ~/*.tmp 2>/dev/null

# Verificar espa√ßo em disco
df -h /data

echo "‚úÖ Limpeza conclu√≠da!"
EOF
    
    chmod +x ~/scripts/cleaner.sh
}

# ============= SCRIPTS DE UTILIDADE =============

create_utility_scripts() {
    log "SYS" "Criando scripts de utilidade..."
    
    # Script de inicializa√ß√£o segura
    cat > ~/scripts/start_safe.sh << 'EOF'
#!/data/data/com.termux/files/usr/bin/bash
# Inicializador seguro

echo "üîí Inicializa√ß√£o segura ativada..."
echo ""

# Verificar bateria
if ! check_battery; then
    echo "üîã Bateria insuficiente. Conecte o carregador."
    exit 1
fi

# Verificar temperatura
if ! check_temperature; then
    echo "üå°Ô∏è  Temperatura elevada. Aguarde resfriamento."
    exit 1
fi

# Verificar conex√£o
if ! ping -c 2 8.8.8.8 >/dev/null 2>&1; then
    echo "üåê Sem conex√£o com internet"
    exit 1
fi

echo "‚úÖ Todas as verifica√ß√µes passaram!"
echo "üöÄ Iniciando minera√ß√£o segura..."

# Iniciar com prioridade baixa
nohup nice -n 19 ~/xmrig/xmrig -c ~/config.json > ~/miner_logs/system/miner.log 2>&1 &

# Iniciar protetor t√©rmico
nohup ~/scripts/thermal_protector.sh > /dev/null 2>&1 &

echo "‚úÖ Sistema iniciado com prote√ß√µes ativas"
echo "üìä Monitor: ~/scripts/monitor.sh"
EOF
    
    chmod +x ~/scripts/start_safe.sh
    
    # Script de status completo
    cat > ~/scripts/full_status.sh << 'EOF'
#!/data/data/com.termux/files/usr/bin/bash
# Status completo do sistema

echo "üìà STATUS COMPLETO DO SISTEMA"
echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"

# Hardware
echo "üíª HARDWARE:"
echo "  CPU: $(nproc) cores"
echo "  RAM: $(free -h | grep Mem | awk '{print $2}') total"
echo "  Armazenamento: $(df -h /data | tail -1 | awk '{print $4}') livre"

# Minera√ß√£o
echo ""
echo "‚õèÔ∏è  MINERA√á√ÉO:"
if pgrep -x "xmrig" >/dev/null; then
    echo "  Status: ${GREEN}ATIVA${NC}"
    echo "  PID: $(pgrep xmrig)"
    echo "  Tempo: $(ps -o etime= -p $(pgrep xmrig) | xargs)"
    
    # Estat√≠sticas do minerador
    if [ -f ~/miner_logs/system/miner.log ]; then
        echo "  Hashrate: $(tail -5 ~/miner_logs/system/miner.log | grep -o "[0-9]*\.[0-9]* H/s" | tail -1)"
        echo "  Shares: $(tail -10 ~/miner_logs/system/miner.log | grep "accepted" | wc -l) aceitas"
    fi
else
    echo "  Status: ${RED}INATIVA${NC}"
fi

# Sistema
echo ""
echo "üñ•Ô∏è  SISTEMA:"
echo "  Uso CPU: $(top -bn1 | grep "CPU" | head -1 | awk '{print $2}')%"
echo "  Uso RAM: $(free -m | grep Mem | awk '{printf "%.1f%%", $3/$2*100}')"
echo "  Temperatura: $(check_temperature && echo "${CURRENT_TEMP}¬∞C")"
echo "  Uptime: $(uptime -p)"

# Logs
echo ""
echo "üìÅ LOGS:"
echo "  Sistema: $(wc -l ~/miner_logs/system.log 2>/dev/null | awk '{print $1}') linhas"
echo "  Performance: $(wc -l ~/miner_logs/performance/miner.log 2>/dev/null | awk '{print $1}') linhas"
echo "  Erros: $(wc -l ~/miner_logs/errors/errors.log 2>/dev/null | awk '{print $1}') linhas"

echo ""
echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
EOF
    
    chmod +x ~/scripts/full_status.sh
    
    # Script de backup autom√°tico
    cat > ~/scripts/backup_system.sh << 'EOF'
#!/data/data/com.termux/files/usr/bin/bash
# Backup do sistema

BACKUP_DIR=~/backups
BACKUP_FILE="backup_$(date +%Y%m%d_%H%M%S).tar.gz"

echo "üíæ Criando backup do sistema..."
mkdir -p $BACKUP_DIR

# Compactar arquivos importantes
tar -czf $BACKUP_DIR/$BACKUP_FILE \
    ~/config.json \
    ~/miner_logs \
    ~/scripts \
    ~/xmrig/xmrig 2>/dev/null

echo "‚úÖ Backup criado: $BACKUP_DIR/$BACKUP_FILE"
echo "üì¶ Tamanho: $(du -h $BACKUP_DIR/$BACKUP_FILE | cut -f1)"

# Manter apenas √∫ltimos 5 backups
cd $BACKUP_DIR
ls -t backup_*.tar.gz | tail -n +6 | xargs rm -f 2>/dev/null
EOF
    
    chmod +x ~/scripts/backup_system.sh
}

# ============= INSTALA√á√ÉO COMPLETA =============

install_complete_system() {
    log "SYS" "Iniciando instala√ß√£o completa do sistema..."
    
    # Verificar seguran√ßa
    check_security
    
    # Instalar sistema
    install_system
    
    # Criar configura√ß√£o inteligente
    create_smart_config
    
    # Criar sistema de prote√ß√£o
    create_protection_system
    
    # Backup inicial
    ~/scripts/backup_system.sh
    
    # Notificar conclus√£o
    send_discord_installation_complete
}

send_discord_installation_complete() {
    local device_info="CPU: $(nproc) cores | RAM: $(free -h | grep Mem | awk '{print $2}')"
    local message="‚úÖ SISTEMA INSTALADO COM SUCESSO
üì± Dispositivo: $(hostname)
üíª $device_info
üõ°Ô∏è  Prote√ß√µes: Ativas
üå°Ô∏è  Monitoramento: Habilitado
üë∑ Worker: $WORKER
üí∞ Carteira: $WALLET"
    
    curl -s -H "Content-Type: application/json" \
         -X POST \
         -d "{\"content\":\"$message\"}" \
         "$DISCORD_WEBHOOK" >/dev/null 2>&1
}

# ============= MENU INTERATIVO SIMPLIFICADO =============

show_quick_menu() {
    echo ""
    echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
    echo ""
    echo "üéØ COMANDOS DISPON√çVEIS:"
    echo ""
    echo "1. üöÄ Iniciar minera√ß√£o segura"
    echo "   $ ~/scripts/start_safe.sh"
    echo ""
    echo "2. üìä Ver status completo"
    echo "   $ ~/scripts/full_status.sh"
    echo ""
    echo "3. üìà Monitor em tempo real"
    echo "   $ ~/scripts/monitor.sh"
    echo ""
    echo "4. üßπ Limpar sistema"
    echo "   $ ~/scripts/cleaner.sh"
    echo ""
    echo "5. üíæ Criar backup"
    echo "   $ ~/scripts/backup_system.sh"
    echo ""
    echo "6. üõë Parar minera√ß√£o"
    echo "   $ pkill xmrig"
    echo ""
    echo "7. üîß Editar configura√ß√£o"
    echo "   $ nano ~/config.json"
    echo ""
    echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
    echo ""
}

# ============= EXECU√á√ÉO PRINCIPAL =============

main() {
    log "INFO" "Iniciando sistema de minera√ß√£o seguro..."
    
    # Instalar sistema completo
    install_complete_system
    
    # Mostrar informa√ß√µes
    echo ""
    echo -e "${GREEN}‚úÖ INSTALA√á√ÉO CONCLU√çDA COM SUCESSO!${NC}"
    echo ""
    
    # Mostrar menu r√°pido
    show_quick_menu
    
    # Iniciar minera√ß√£o automaticamente (modo seguro)
    echo "‚è≥ Iniciando minera√ß√£o em modo seguro..."
    sleep 3
    ~/scripts/start_safe.sh
    
    # Mostrar status inicial
    sleep 5
    echo ""
    echo "üìã STATUS INICIAL:"
    echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
    if pgrep -x "xmrig" >/dev/null; then
        echo "‚úÖ Minera√ß√£o iniciada com SUCESSO"
        echo "üìä Monitorando em background..."
        echo "üîí Sistema de prote√ß√£o: ATIVO"
    else
        echo "‚ö†Ô∏è  Minera√ß√£o n√£o iniciada"
        echo "üí° Execute: ~/scripts/start_safe.sh"
    fi
    
    echo ""
    echo "üìù Logs dispon√≠veis em: ~/miner_logs/"
    echo "üîÑ Sistema otimizado para seguran√ßa e desempenho"
    echo ""
    echo "‚ö†Ô∏è  IMPORTANTE: Monitore a temperatura do dispositivo"
    echo "üîã Mantenha carregador conectado para melhor desempenho"
    echo ""
}

# Executar sistema
main
