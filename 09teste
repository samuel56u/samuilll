#!/data/data/com.termux/files/usr/bin/bash

# ====================================================
# SISTEMA DE MINERA√á√ÉO NICEHASH SILENCIOSO
# VERS√ÉO: SILENT 1.0 - ZERO INTERA√á√ÉO
# ====================================================

# CONFIGURA√á√ïES
NICEHASH_API_KEY="7d8889ce-0391-4f65-bf9d-bce2c696a6ef"
NICEHASH_API_SECRET="30050e97-a129-4c74-bd52-8c36fc365fe80def10b"
NICEHASH_ORG_ID="5c88fb09-353c-42f4-adbb-433787cd8077"
NICEHASH_WALLET="bc1qtz2j3ky2nh409w432wh8uyqphhny84a3qhs2tl"

POOL_HOST="sha256.usa.nicehash.com"
POOL_PORT="3334"
WORKER_NAME="termux_silent"
THREADS=1

DISCORD_WEBHOOK="https://discord.com/api/webhooks/1470009252063088661/1j4kNu2sDcGQmFCywnbd_p1BEbb1DTcN_VXt5OYpX8_FsQI2YKB3tCjS2Okp_msUX9Mh"

# DIRET√ìRIOS
BASE_DIR="$HOME/.nh_silent"
LOG_DIR="$BASE_DIR/logs"
PID_FILE="$BASE_DIR/pid"
LOCK_FILE="$BASE_DIR/lock"

# FUN√á√ÉO: LOG SILENCIOSO
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> "$LOG_DIR/system.log"
}

# INICIALIZAR SILENCIOSAMENTE
init_silent() {
    # Criar diret√≥rios
    mkdir -p "$BASE_DIR" "$LOG_DIR"
    
    # Verificar se j√° est√° rodando
    if [ -f "$LOCK_FILE" ]; then
        log "Sistema j√° est√° rodando"
        exit 0
    fi
    
    # Criar lock file
    echo $$ > "$LOCK_FILE"
    
    log "=== INICIANDO SISTEMA SILENCIOSO ==="
    
    # Atualizar pacotes (silencioso)
    pkg update -y > /dev/null 2>&1
    pkg upgrade -y > /dev/null 2>&1
    
    # Instalar depend√™ncias se necess√°rio
    if ! command -v git > /dev/null 2>&1; then
        pkg install -y git curl wget python3 jq bc openssl-tool proot > /dev/null 2>&1
    fi
    
    # Instalar/compilar minerador
    install_miner_silent
    
    # Iniciar minera√ß√£o
    start_mining_silent
    
    # Iniciar monitoramento
    start_monitor_silent
}

# INSTALAR MINERADOR SILENCIOSO
install_miner_silent() {
    MINER_DIR="$BASE_DIR/miner"
    mkdir -p "$MINER_DIR"
    cd "$MINER_DIR"
    
    # Verificar se j√° existe
    if [ -f "$MINER_DIR/cpuminer" ]; then
        log "Minerador j√° instalado"
        return 0
    fi
    
    log "Instalando minerador..."
    
    # Tentar baixar pr√©-compilado
    if wget -q https://github.com/tpruvot/cpuminer-multi/releases/download/v2.5.1/cpuminer-multi-arm64-2.5.1.tar.gz; then
        tar -xzf cpuminer-multi-arm64-2.5.1.tar.gz
        mv cpuminer-multi-arm64/cpuminer ./
        chmod +x cpuminer
        log "Minerador baixado"
        return 0
    fi
    
    # Compilar
    git clone -q https://github.com/tpruvot/cpuminer-multi
    cd cpuminer-multi
    
    ./build.sh > /dev/null 2>&1
    ./autogen.sh > /dev/null 2>&1
    ./configure CFLAGS="-march=native" > /dev/null 2>&1
    make -j2 > /dev/null 2>&1
    
    if [ -f "cpuminer" ]; then
        cp cpuminer "$MINER_DIR/"
        chmod +x "$MINER_DIR/cpuminer"
        log "Minerador compilado"
    else
        log "ERRO: Falha na instala√ß√£o"
        exit 1
    fi
}

# INICIAR MINERA√á√ÉO SILENCIOSA
start_mining_silent() {
    MINER_DIR="$BASE_DIR/miner"
    cd "$MINER_DIR"
    
    # Parar se j√° estiver rodando
    if [ -f "$PID_FILE" ]; then
        OLD_PID=$(cat "$PID_FILE")
        kill -9 "$OLD_PID" 2>/dev/null
    fi
    
    # Criar script de execu√ß√£o
    cat > "$MINER_DIR/run.sh" << EOF
#!/data/data/com.termux/files/usr/bin/bash
while true; do
    ./cpuminer -a sha256 \\
        -o stratum+tcp://$POOL_HOST:$POOL_PORT \\
        -u $NICEHASH_API_KEY.$WORKER_NAME \\
        -p x \\
        -t $THREADS \\
        --quiet \\
        --retry-pause=10
    sleep 5
done
EOF
    
    chmod +x "$MINER_DIR/run.sh"
    
    # Executar em background
    nohup "$MINER_DIR/run.sh" > "$LOG_DIR/miner.log" 2>&1 &
    
    MINER_PID=$!
    echo $MINER_PID > "$PID_FILE"
    
    log "Minerador iniciado: PID $MINER_PID"
    
    # Notifica√ß√£o Discord
    send_discord_silent "START"
}

# MONITORAMENTO SILENCIOSO
start_monitor_silent() {
    (
        while true; do
            sleep 60
            
            # Verificar minerador
            if [ ! -f "$PID_FILE" ]; then
                log "ERRO: PID file n√£o encontrado"
                start_mining_silent
                continue
            fi
            
            PID=$(cat "$PID_FILE" 2>/dev/null)
            if [ -z "$PID" ] || ! kill -0 "$PID" 2>/dev/null; then
                log "Minerador parou, reiniciando..."
                start_mining_silent
            fi
            
            # Verificar temperatura a cada 10 minutos
            if [ $(( $(date +%s) % 600 )) -eq 0 ]; then
                check_temp_silent
            fi
            
            # Status a cada hora
            if [ $(( $(date +%s) % 3600 )) -eq 0 ]; then
                send_status_silent
            fi
        done
    ) &
    
    log "Monitoramento iniciado"
}

# VERIFICAR TEMPERATURA SILENCIOSO
check_temp_silent() {
    if [ -f "/sys/class/thermal/thermal_zone0/temp" ]; then
        TEMP=$(( $(cat /sys/class/thermal/thermal_zone0/temp) / 1000 ))
        
        if [ $TEMP -gt 75 ]; then
            log "ALERTA TEMP: ${TEMP}¬∞C"
            
            # Reduzir carga
            if [ $TEMP -gt 80 ] && [ $THREADS -gt 1 ]; then
                THREADS=$((THREADS - 1))
                log "Reduzindo threads para $THREADS"
                restart_silent
            fi
        fi
    fi
}

# REINICIAR SILENCIOSO
restart_silent() {
    log "Reiniciando minerador..."
    
    if [ -f "$PID_FILE" ]; then
        kill $(cat "$PID_FILE") 2>/dev/null
        sleep 3
    fi
    
    start_mining_silent
}

# ENVIAR STATUS SILENCIOSO
send_status_silent() {
    UPTIME=$(uptime -p)
    TEMP=$(get_temp_simple_silent)
    
    curl -s -H "Content-Type: application/json" -X POST \
        -d "{\"content\":\"üìä **STATUS SILENCIOSO**\\n‚è∞ $UPTIME\\nüå°Ô∏è ${TEMP}¬∞C\\nüë∑ $WORKER_NAME\\n‚è±Ô∏è $(date '+%H:%M')\"}" \
        "$DISCORD_WEBHOOK" > /dev/null 2>&1
}

# ENVIAR DISCORD SILENCIOSO
send_discord_silent() {
    TYPE=$1
    
    case $TYPE in
        "START")
            MSG="üöÄ **INICIADO SILENCIOSAMENTE**\\n‚úÖ Sistema ativo\\nüë∑ $WORKER_NAME\\n‚è∞ $(date '+%H:%M:%S')"
            ;;
        "STOP")
            MSG="üõë **PARADO SILENCIOSAMENTE**\\n‚èπÔ∏è Sistema encerrado\\n‚è∞ $(date '+%H:%M:%S')"
            ;;
        *)
            MSG="üì¢ **NOTIFICA√á√ÉO SILENCIOSA**\\n‚è∞ $(date '+%H:%M:%S')"
            ;;
    esac
    
    curl -s -H "Content-Type: application/json" -X POST \
        -d "{\"content\":\"$MSG\"}" \
        "$DISCORD_WEBHOOK" > /dev/null 2>&1
}

# UTILIT√ÅRIOS
get_temp_simple_silent() {
    if [ -f "/sys/class/thermal/thermal_zone0/temp" ]; then
        echo $(($(cat /sys/class/thermal/thermal_zone0/temp) / 1000))
    else
        echo "N/A"
    fi
}

# LIMPEZA
cleanup_silent() {
    log "Limpando..."
    
    # Parar minerador
    if [ -f "$PID_FILE" ]; then
        kill $(cat "$PID_FILE") 2>/dev/null
    fi
    
    # Remover lock
    rm -f "$LOCK_FILE"
    
    # Notifica√ß√£o
    send_discord_silent "STOP"
    
    log "Sistema finalizado"
    exit 0
}

# TRAP
trap cleanup_silent SIGINT SIGTERM EXIT

# EXECUTAR
init_silent

# MANTER VIVO
while true; do
    sleep 86400  # 24 horas
done
